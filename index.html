<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AI Strategy Game - TNO Redux Edition</title>
    <style>
      /* === ÂÖ®‰ΩìË®≠ÂÆö (TNOÈ¢®„ÉÄ„Éº„ÇØ„ÉÜ„Éº„Éû) === */
      body {
        background: #121212;
        color: #e0e0e0;
        font-family: "Yu Gothic UI", "Segoe UI", sans-serif;
        margin: 0;
        overflow: hidden;
        user-select: none;
      }

      /* === „Éà„ÉÉ„Éó„Éê„Éº === */
      #topbar {
        display: flex;
        height: 50px;
        background: #1f1f1f;
        border-bottom: 1px solid #333;
        align-items: center;
        padding: 0 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
        z-index: 20;
      }
      .flag {
        font-size: 28px;
        margin-right: 15px;
        cursor: pointer;
        transition: 0.2s;
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.5));
      }
      .flag:hover {
        transform: scale(1.1);
      }
      .res-grp {
        display: flex;
        gap: 15px;
        margin-right: 20px;
        border-right: 1px solid #444;
        padding-right: 20px;
      }
      .res {
        display: flex;
        align-items: center;
        font-size: 13px;
        font-weight: bold;
      }
      .icon {
        width: 14px;
        height: 14px;
        display: inline-block;
        margin-right: 6px;
        border-radius: 3px;
        box-shadow: 0 1px 3px #000;
      }
      .date-box {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 5px;
        background: #222;
        padding: 3px 10px;
        border-radius: 20px;
        border: 1px solid #444;
      }
      .spd-btn {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        font-weight: bold;
        padding: 2px 6px;
        transition: 0.2s;
      }
      .spd-btn.active {
        color: #fff;
        text-shadow: 0 0 5px var(--hl);
      }

      /* === „É¨„Ç§„Ç¢„Ç¶„Éà === */
      #game-layout {
        display: flex;
        height: calc(100vh - 50px);
      }
      #sidebar {
        width: 320px;
        background: #1a1a1a;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        z-index: 10;
        box-shadow: 2px 0 15px rgba(0, 0, 0, 0.6);
      }
      .tabs {
        display: flex;
        height: 45px;
        background: #151515;
      }
      .tab {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #666;
        border-bottom: 3px solid transparent;
        font-size: 14px;
        transition: 0.2s;
        font-weight: bold;
      }
      .tab:hover {
        background: #222;
        color: #999;
      }
      .tab.active {
        color: #fff;
        border-bottom-color: var(--hl);
        background: #252525;
      }
      .view {
        padding: 20px;
        display: none;
        flex: 1;
        overflow-y: auto;
      }
      .view.active {
        display: block;
      }

      /* === „Éû„ÉÉ„Éó„Ç®„É™„Ç¢ === */
      #map-wrap {
        flex: 1;
        position: relative;
        overflow: hidden;
        background: #050a10;
        cursor: grab;
      }
      #game-svg {
        width: 100%;
        height: 100%;
        overflow: visible;
        transform-origin: 0 0;
        will-change: transform;
      }
      .hex {
        stroke: #000;
        stroke-width: 1;
        transition: fill 0.2s;
        vector-effect: non-scaling-stroke;
      }
      .hex:hover {
        stroke: #fff;
        stroke-width: 2;
      }
      .hex.sea {
        fill: #050a10;
        stroke: none;
      }

      /* === „É¶„Éã„ÉÉ„Éà === */
      .unit-grp {
        cursor: pointer;
        will-change: transform;
        transition: filter 0.2s;
      }
      .unit-grp:hover {
        filter: brightness(1.5);
        z-index: 1000;
      }
      .unit-grp.selected .unit-box {
        stroke: #fff;
        stroke-width: 1.5;
        filter: drop-shadow(0 0 3px #fff);
      }
      .unit-box {
        width: 22px;
        height: 14px;
        fill: #333;
        stroke: #000;
        stroke-width: 1;
      }
      .unit-icon {
        font-size: 10px;
        fill: #fff;
        text-anchor: middle;
        pointer-events: none;
      }
      .unit-bar {
        fill: #00e676;
      }
      .unit-org-bar {
        fill: #ff9100;
      }
      .unit-inner.fighting .unit-box {
        stroke: #ff5252;
        stroke-width: 2px;
      }

      /* === „Éï„Ç©„Éº„Ç´„Çπ„ÉÑ„É™„ÉºÔºàÂ§ßË¶èÊ®°ÂØæÂøúÔºâ === */
      #focus-modal .modal-body {
        overflow: hidden;
        cursor: grab;
        background: #111;
      }
      #focus-modal .modal-body:active {
        cursor: grabbing;
      }
      #focus-canvas {
        width: 3000px;
        height: 2000px;
        position: relative;
        background-image: radial-gradient(#333 1px, transparent 1px);
        background-size: 30px 30px;
        transform-origin: 0 0;
      }

      .focus-node {
        position: absolute;
        width: 240px;
        min-height: 90px;
        padding: 12px;
        background: #222;
        border: 2px solid #444;
        color: #ccc;
        font-size: 13px;
        cursor: pointer;
        text-align: center;
        z-index: 2;
        border-radius: 2px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.8);
        transition: 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .focus-node:hover {
        transform: scale(1.05);
        z-index: 10;
        border-color: #fff;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
      }
      .focus-node.completed {
        border-color: var(--hl);
        background: #00332c;
        color: #80cbc4;
      }
      .focus-node.available {
        border-color: var(--warn);
        background: #2a2510;
        box-shadow: 0 0 10px rgba(253, 216, 53, 0.2);
      }
      .focus-node.locked {
        opacity: 0.4;
        filter: grayscale(1);
        pointer-events: none;
      }
      .focus-node.exclusive-locked {
        border-color: #d32f2f;
        opacity: 0.6;
        filter: grayscale(1);
        pointer-events: none;
        background: #300;
      }

      .focus-title {
        font-weight: bold;
        font-size: 15px;
        margin-bottom: 5px;
        color: #fff;
      }
      .focus-desc {
        font-size: 12px;
        color: #888;
        margin-bottom: 5px;
      }
      .focus-cost {
        font-size: 11px;
        color: #666;
      }
      .focus-lines-svg {
        position: absolute;
        inset: 0;
        pointer-events: none;
        width: 100%;
        height: 100%;
      }

      /* === TNOÈ¢®„Çπ„Éº„Éë„Éº„Ç§„Éô„É≥„Éà (Êó•Êú¨Ë™ûÁâà) === */
      #super-event-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 20000;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
      }
      .se-container {
        width: 650px;
        height: 500px;
        background: #000;
        border: 4px solid #e0e0e0;
        position: relative;
        box-shadow: 0 0 60px rgba(255, 255, 255, 0.15);
        display: flex;
        flex-direction: column;
      }
      .se-scanlines {
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
          transparent 0px,
          transparent 2px,
          rgba(0, 0, 0, 0.5) 4px
        );
        pointer-events: none;
        opacity: 0.4;
        z-index: 5;
        animation: flicker 0.15s infinite;
      }
      @keyframes flicker {
        0% {
          opacity: 0.38;
        }
        50% {
          opacity: 0.42;
        }
        100% {
          opacity: 0.38;
        }
      }

      .se-image-area {
        height: 300px;
        background: #222;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 2px solid #fff;
      }
      .se-title-box {
        background: #000;
        color: #fff;
        padding: 10px 0;
        border-top: 2px solid #fff;
        border-bottom: 2px solid #fff;
        margin-top: -30px;
        z-index: 10;
        width: 80%;
        text-align: center;
        margin-left: 10%;
        position: relative;
      }
      .se-title {
        font-family: "MS Mincho", "Hiragino Mincho ProN", serif;
        font-size: 32px;
        font-weight: 900;
        letter-spacing: 5px;
        text-shadow: 0 0 10px #fff;
      }

      .se-quote-box {
        flex: 1;
        padding: 20px 40px;
        color: #fff;
        font-family: "MS Mincho", "Hiragino Mincho ProN", serif;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .se-quote {
        font-size: 18px;
        margin-bottom: 15px;
        color: #ddd;
        line-height: 1.4;
        font-style: italic;
      }
      .se-author {
        font-size: 14px;
        color: #888;
        align-self: flex-end;
      }

      .se-btn {
        width: 100%;
        padding: 15px;
        background: #fff;
        color: #000;
        border: none;
        font-family: "MS Mincho", "Hiragino Mincho ProN", serif;
        font-weight: 900;
        font-size: 20px;
        cursor: pointer;
        transition: 0.2s;
        border-top: 2px solid #888;
      }
      .se-btn:hover {
        background: #ccc;
        letter-spacing: 3px;
      }

      /* === „Åù„ÅÆ‰ªñUI === */
      .btn {
        width: 100%;
        padding: 10px;
        background: linear-gradient(to bottom, #3a3a3a, #252525);
        border: 1px solid #444;
        color: #fff;
        cursor: pointer;
        margin-bottom: 10px;
        border-radius: 2px;
        font-weight: bold;
        text-shadow: 0 1px 2px #000;
        box-shadow: 0 2px 0 #111;
        transition: 0.1s;
      }
      .btn:hover {
        filter: brightness(1.2);
      }
      .btn-green {
        background: linear-gradient(to bottom, #2e7d32, #1b5e20);
        border-color: #1b5e20;
      }
      .btn-red {
        background: linear-gradient(to bottom, #c62828, #b71c1c);
        border-color: #b71c1c;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }
      .modal-win {
        width: 90%;
        max-width: 1200px;
        height: 85%;
        background: #1a1a1a;
        border: 1px solid #444;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px #000;
        border-radius: 4px;
        overflow: hidden;
      }
      .modal-head {
        padding: 10px 20px;
        background: #252525;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
      }

      /* „Éá„Ç∂„Ç§„Éä„Éº */
      .ds-layout {
        display: flex;
        height: 100%;
      }
      .ds-panel {
        width: 250px;
        background: #222;
        border-right: 1px solid #444;
        padding: 15px;
        overflow-y: auto;
      }
      .ds-main {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #181818;
      }
      .ds-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 20px;
        background: #252525;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #333;
      }
      .slot {
        width: 60px;
        height: 60px;
        background: #333;
        border: 1px dashed #555;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        position: relative;
        border-radius: 3px;
        transition: 0.1s;
      }
      .slot.filled {
        border-style: solid;
        border-color: var(--hl);
        background: #2b2b2b;
      }
      .unit-opt {
        padding: 8px;
        background: #333;
        border: 1px solid #444;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
        border-radius: 3px;
        transition: 0.1s;
      }
      .unit-opt:hover {
        background: #444;
        border-color: #666;
        transform: translateX(3px);
      }

      :root {
        --hl: #00bcd4;
        --warn: #ffca28;
        --danger: #ef5350;
        --good: #66bb6a;
      }
      #news-feed {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 300px;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 50;
      }
      .news {
        background: rgba(20, 20, 20, 0.95);
        color: #fff;
        padding: 12px 15px;
        border-left: 4px solid #aaa;
        font-size: 13px;
        border-radius: 2px;
        animation: slideIn 0.3s;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      #start-screen {
        position: fixed;
        inset: 0;
        background: #111;
        z-index: 9000;
        display: none;
        flex-direction: column;
        align-items: center;
        padding: 50px;
      }
      .country-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
        width: 100%;
        max-width: 1200px;
        overflow-y: auto;
        padding-bottom: 50px;
      }
      .country-card {
        background: #222;
        border: 1px solid #444;
        border-radius: 5px;
        padding: 15px;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .country-card:hover {
        background: #333;
        border-color: var(--hl);
        transform: translateY(-5px);
      }

      .sb-profile {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        background: #333;
        padding: 15px;
        border-radius: 5px;
      }
      .focus-btn-custom {
        position: relative;
        height: 60px;
        text-align: left;
        padding-left: 15px;
      }
      .focus-bar-bg {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 4px;
        width: 100%;
        background: #222;
      }
      .focus-bar-progress {
        height: 100%;
        width: 0;
        background: var(--warn);
        transition: 0.2s;
      }
      #select-box {
        position: absolute;
        border: 1px solid #fff;
        background: rgba(255, 255, 255, 0.1);
        display: none;
        pointer-events: none;
        z-index: 10;
      }
      #loading-overlay {
        position: fixed;
        inset: 0;
        background: #111;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #fff;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #333;
        border-top-color: var(--hl);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <!-- TNO „Çπ„Éº„Éë„Éº„Ç§„Éô„É≥„Éà (Êó•Êú¨Ë™ûÁâà) -->
    <div id="super-event-overlay">
      <div class="se-container">
        <div class="se-scanlines"></div>
        <div class="se-image-area" id="se-img-box">
          <div
            style="font-size: 120px; opacity: 0.3; filter: blur(2px)"
            id="se-icon"
          >
            ‚öîÔ∏è
          </div>
          <div class="se-title-box">
            <div class="se-title" id="se-title">Â§ßÊù±‰∫úÊà¶‰∫âÂãÉÁô∫</div>
          </div>
        </div>
        <div class="se-quote-box">
          <div class="se-quote" id="se-quote">
            „ÄåË≥Ω„ÅØÊäï„Åí„Çâ„Çå„Åü„ÄÇ„ÇÇ„ÅØ„ÇÑÂæåÊàª„Çä„ÅØ„Åß„Åç„Å™„ÅÑ„ÄÇ„Äç
          </div>
          <div class="se-author" id="se-author">- ÊåáÂ∞éËÄÖ</div>
        </div>
        <button class="se-btn" onclick="SuperEvent.close()" id="se-btn-text">
          ÂÜ∑Èùô„É≤‰øù„ÉÜ„ÄÇ
        </button>
      </div>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
    <div id="loading-overlay">
      <div class="spinner"></div>
      <div id="loading-text">Âú∞Âõ≥„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>

    <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
    <div id="start-screen">
      <div
        style="
          font-size: 36px;
          font-weight: bold;
          margin-bottom: 10px;
          color: var(--hl);
        "
      >
        AI Strategy Game: Redux
      </div>
      <div style="color: #aaa; margin-bottom: 40px">
        „Éó„É¨„Ç§„Åô„ÇãÂõΩÂÆ∂(ÈÉΩÈÅìÂ∫úÁúå)„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
      </div>
      <div id="country-list" class="country-grid"></div>
    </div>

    <div id="select-box"></div>

    <!-- „Éà„ÉÉ„Éó„Éê„Éº -->
    <div id="topbar">
      <div class="flag" onclick="UI.toggleSidebar()" id="player-flag">üè≥Ô∏è</div>
      <div class="res-grp">
        <div class="res" title="ÊîøÊ≤ªÂäõ">
          <span class="icon" style="background: #8d6e63"></span
          ><span class="val" id="res-pp">0</span>
        </div>
        <div class="res" title="ÂÆâÂÆöÂ∫¶">
          <span class="icon" style="background: #fbc02d"></span
          ><span class="val" id="res-st">0%</span>
        </div>
        <div class="res" title="Êà¶‰∫âÂçîÂäõÂ∫¶">
          <span class="icon" style="background: #d32f2f"></span
          ><span class="val" id="res-ws">0%</span>
        </div>
      </div>
      <div class="res-grp">
        <div class="res" title="‰∫∫ÁöÑË≥áÊ∫ê">
          <span class="icon" style="background: #5d4037"></span
          ><span class="val" id="res-man">0</span>
        </div>
        <div class="res" title="Ê≠©ÂÖµË£ÖÂÇô">
          <span class="icon" style="background: #ff9800"></span
          ><span class="val" id="res-eq">0</span>
        </div>
        <div class="res" title="Èô∏ËªçÁµåÈ®ìÂÄ§">
          <span class="icon" style="background: #66bb6a"></span
          ><span class="val" id="res-xp">0</span>
        </div>
      </div>
      <div class="date-box">
        <button class="spd-btn" onclick="Game.setSpeed(0)">||</button>
        <button class="spd-btn active" onclick="Game.setSpeed(1)">1</button>
        <button class="spd-btn" onclick="Game.setSpeed(3)">3</button>
        <button class="spd-btn" onclick="Game.setSpeed(5)">5</button>
        <div
          id="game-date"
          style="font-weight: bold; margin-left: 8px; font-size: 14px"
        >
          Day 1
        </div>
      </div>
    </div>

    <!-- „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà -->
    <div id="game-layout">
      <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
      <div id="sidebar">
        <div class="tabs">
          <div class="tab active" onclick="UI.tab('main')">ÂõΩÂÆ∂</div>
          <div class="tab" onclick="UI.tab('army')">Ëªç‰∫ã</div>
          <div class="tab" onclick="UI.tab('diplo')">Â§ñ‰∫§</div>
        </div>

        <!-- ÂõΩÂÆ∂„Çø„Éñ -->
        <div id="v-main" class="view active">
          <div class="sb-profile">
            <div class="sb-portrait-wrapper" id="sb-portrait">?</div>
            <div>
              <div style="font-weight: bold; font-size: 14px" id="sb-name">
                Country
              </div>
              <div style="font-size: 12px; color: #aaa" id="sb-ideology">
                Prefecture
              </div>
            </div>
          </div>
          <button class="btn focus-btn-custom" onclick="UI.openFocusTree()">
            <span class="focus-caption">ÂõΩÂÆ∂ÊñπÈáù</span><br />
            <span id="sb-focus-curr" class="focus-name">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
            <div class="focus-bar-bg">
              <div id="sb-focus-bar" class="focus-bar-progress"></div>
            </div>
          </button>
          <button
            class="btn btn-green"
            style="margin-top: 10px"
            onclick="Game.buildFactory()"
          >
            <span style="font-size: 16px">Â∑•Â†¥Âª∫Ë®≠</span><br />
            <span style="font-size: 11px; font-weight: normal"
              >ÊîøÊ≤ªÂäõ:50, Âª∫Ë®≠ÊúüÈñì:10Êó•</span
            >
          </button>
          <div style="margin-top: 20px; font-size: 13px; color: #aaa">
            <div>
              ‰∏ñÁïåÁ∑äÂºµÂ∫¶:
              <span id="val-wt" style="color: var(--danger); font-weight: bold"
                >0%</span
              >
            </div>
            <div>Â∑•Â†¥Êï∞: <span id="res-fac" style="color: #fff">0</span></div>
          </div>
        </div>

        <!-- Ëªç‰∫ã„Çø„Éñ -->
        <div id="v-army" class="view">
          <div
            style="
              background: #333;
              padding: 10px;
              border-radius: 5px;
              margin-bottom: 15px;
              border: 1px solid #444;
            "
          >
            <div
              style="
                font-size: 12px;
                color: #aaa;
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
              "
            >
              <span>ÁèæÂú®„ÅÆÂ∏´Âõ£„ÉÜ„É≥„Éó„É¨„Éº„Éà</span>
              <span
                style="color: var(--hl); cursor: pointer"
                onclick="UI.openDesigner()"
                >[Á∑®ÈõÜ]</span
              >
            </div>
            <div
              id="army-tmpl-stats"
              style="
                font-size: 11px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 5px;
                color: #ddd;
              "
            ></div>
          </div>
          <button class="btn btn-green" onclick="Game.recruit()">
            <span style="font-size: 16px">Â∏´Âõ£Âæ¥ÂÖµ</span><br />
            <span style="font-size: 11px; font-weight: normal" id="recruit-cost"
              >‰∫∫ÁöÑ:1000 Ë£ÖÂÇô:100</span
            >
          </button>
          <div
            style="
              margin-top: 20px;
              padding-top: 10px;
              border-top: 1px solid #333;
            "
          >
            <div class="focus-caption">
              ÈÅ∏Êäû‰∏≠„ÅÆÂ∏´Âõ£:
              <span id="sel-count" style="color: var(--hl); font-weight: bold"
                >0</span
              >
            </div>
            <div class="focus-caption">
              Á∑èÂ∏´Âõ£Êï∞: <span id="army-count">0</span>
            </div>
            <div class="focus-caption">
              ÊúÄÂ§ßÂ∏´Âõ£Êï∞(1ÂõΩ): <span id="army-cap">50</span>
            </div>
          </div>
        </div>

        <!-- Â§ñ‰∫§„Çø„Éñ -->
        <div id="v-diplo" class="view">
          <div
            id="diplo-msg"
            style="
              padding: 40px 20px;
              text-align: center;
              color: #666;
              border: 2px dashed #333;
              border-radius: 10px;
            "
          >
            Âú∞Âõ≥‰∏ä„ÅÆÂõΩ„Çí<br />„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          </div>
          <div id="diplo-content" style="display: none">
            <h2 id="dp-name" style="color: var(--warn); margin: 0 0 10px 0">
              Country
            </h2>
            <div
              style="
                margin-bottom: 20px;
                padding: 10px;
                background: #333;
                border-radius: 5px;
              "
            >
              <div class="focus-caption">
                Èô£Âñ∂: <span id="dp-faction" style="color: #fff">„Å™„Åó</span>
              </div>
            </div>
            <div
              id="dp-war-status"
              style="
                color: var(--danger);
                font-weight: bold;
                margin-bottom: 15px;
                display: none;
                text-align: center;
                border: 1px solid var(--danger);
                padding: 5px;
              "
            >
              ‚ö° ‰∫§Êà¶‰∏≠ ‚ö°
            </div>
            <button
              class="btn btn-red"
              id="btn-declare-war"
              onclick="Game.justifyWar()"
            >
              ÂÆ£Êà¶Â∏ÉÂëä„ÅÆÊ≠£ÂΩìÂåñ
            </button>
          </div>
        </div>
      </div>

      <!-- „Éû„ÉÉ„Éó -->
      <div id="map-wrap">
        <div id="news-feed"></div>
      </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: ÂõΩÂÆ∂ÊñπÈáù (Ë∂ÖÂ§ßË¶èÊ®° + „Éâ„É©„ÉÉ„Ç∞„Çπ„ÇØ„É≠„Éº„É´) -->
    <div id="focus-modal" class="modal">
      <div class="modal-win">
        <div class="modal-head">
          <span style="font-size: 18px; font-weight: bold; color: #ddd"
            >ÂõΩÂÆ∂ÊñπÈáù„ÉÑ„É™„Éº („Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÁßªÂãï)</span
          >
          <button
            class="spd-btn"
            style="font-size: 20px"
            onclick="UI.closeFocusTree()"
          >
            √ó
          </button>
        </div>
        <div class="modal-body" id="focus-scroll-area">
          <div id="focus-canvas">
            <svg id="focus-lines" class="focus-lines-svg"></svg>
            <div id="focus-nodes"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´: Â∏´Âõ£Ë®≠Ë®à -->
    <div id="design-modal" class="modal">
      <div class="modal-win" style="width: 1000px; height: 800px">
        <div class="modal-head">
          <div style="display: flex; align-items: center; gap: 10px">
            <span style="font-size: 18px; font-weight: bold"
              >Â∏´Âõ£Á∑®Êàê„Éá„Ç∂„Ç§„Éä„Éº</span
            >
            <span
              style="
                font-size: 12px;
                background: #444;
                padding: 2px 8px;
                border-radius: 10px;
              "
              >‚òÖ <span id="ds-xp">0</span> XP</span
            >
          </div>
          <button
            class="spd-btn"
            style="font-size: 20px"
            onclick="UI.closeDesigner()"
          >
            √ó
          </button>
        </div>
        <div class="ds-layout">
          <div class="ds-panel">
            <div
              style="
                font-size: 12px;
                color: #888;
                text-align: center;
                margin-bottom: 5px;
                font-weight: bold;
              "
            >
              Êà¶ÈóòÂ§ßÈöä
            </div>
            <div id="opt-battalions"></div>
            <div
              style="
                font-size: 12px;
                color: #888;
                text-align: center;
                margin: 20px 0 5px 0;
                font-weight: bold;
              "
            >
              ÊîØÊè¥‰∏≠Èöä
            </div>
            <div id="opt-support"></div>
          </div>
          <div class="ds-main">
            <div style="width: 100%; max-width: 500px">
              <div class="ds-grid">
                <div
                  style="
                    grid-column: 1/-1;
                    font-size: 12px;
                    color: #888;
                    text-align: center;
                    margin-bottom: 5px;
                  "
                >
                  ‰∏ªÂäõÂ§ßÈöä (ÊúÄÂ§ß6)
                </div>
                <div id="grid-bat" style="display: contents"></div>
              </div>
              <div
                class="ds-grid"
                style="grid-template-columns: repeat(3, 1fr)"
              >
                <div
                  style="
                    grid-column: 1/-1;
                    font-size: 12px;
                    color: #888;
                    text-align: center;
                    margin-bottom: 5px;
                  "
                >
                  ÊîØÊè¥‰∏≠Èöä (ÊúÄÂ§ß3)
                </div>
                <div id="grid-sup" style="display: contents"></div>
              </div>
            </div>
            <div
              style="
                width: 100%;
                max-width: 500px;
                background: #222;
                padding: 15px;
                border-radius: 5px;
                margin-top: 10px;
                border: 1px solid #333;
              "
            >
              <div
                style="
                  font-size: 12px;
                  color: #aaa;
                  margin-bottom: 5px;
                  border-bottom: 1px solid #444;
                "
              >
                ‰∫àÊ∏¨„Çπ„ÉÜ„Éº„Çø„Çπ
              </div>
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                  width: 100%;
                  font-size: 13px;
                "
              >
                <div style="display: flex; justify-content: space-between">
                  <span>ÂØæ‰∫∫ÊîªÊíÉ</span
                  ><span
                    style="font-weight: bold; color: var(--warn)"
                    id="ds-atk-s"
                    >0</span
                  >
                </div>
                <div style="display: flex; justify-content: space-between">
                  <span>ÂØæÁî≤ÊîªÊíÉ</span
                  ><span
                    style="font-weight: bold; color: var(--danger)"
                    id="ds-atk-h"
                    >0</span
                  >
                </div>
                <div style="display: flex; justify-content: space-between">
                  <span>Èò≤Âæ°</span
                  ><span style="font-weight: bold; color: #42a5f5" id="ds-def"
                    >0</span
                  >
                </div>
                <div style="display: flex; justify-content: space-between">
                  <span>Ë£ÖÁî≤</span
                  ><span style="font-weight: bold; color: #bdbdbd" id="ds-arm"
                    >0</span
                  >
                </div>
                <div style="display: flex; justify-content: space-between">
                  <span>„Ç≥„Çπ„Éà</span
                  ><span style="font-weight: bold; color: #fff" id="ds-cost"
                    >0</span
                  >
                </div>
              </div>
            </div>
            <button
              class="btn btn-green"
              style="margin-top: 20px; width: 200px"
              onclick="Designer.save()"
            >
              ‰øùÂ≠ò („Ç≥„Çπ„Éà: 10 XP)
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
      const $ = (id) => document.getElementById(id);
      const $c = (t, c) => {
        const e = document.createElement(t);
        if (c) e.className = c;
        return e;
      };
      const nFmt = (n) =>
        n >= 1e6
          ? (n / 1e6).toFixed(2) + "M"
          : n >= 1e3
          ? (n / 1e3).toFixed(1) + "K"
          : n;

      // ÈÖçËâ≤
      let colorHue = Math.random();
      const nextColor = () => {
        colorHue = (colorHue + 0.618033988749895) % 1;
        const h = Math.floor(colorHue * 360);
        return `hsl(${h}, 65%, 45%)`;
      };

      // „Çπ„Éº„Éë„Éº„Ç§„Éô„É≥„Éà (Êó•Êú¨Ë™ûÁâà)
      const SuperEvent = {
        overlay: $("super-event-overlay"),
        title: $("se-title"),
        quote: $("se-quote"),
        author: $("se-author"),
        btnText: $("se-btn-text"),
        imgBox: $("se-img-box"),
        icon: $("se-icon"),

        trigger: function (title, quote, author, iconStr, color, btnText) {
          this.title.innerText = title;
          this.quote.innerHTML = quote.replace(/\n/g, "<br>");
          this.author.innerText = "- " + author;
          this.icon.innerText = iconStr || "‚öîÔ∏è";
          this.btnText.innerText = btnText || "ÊÆã„É´„ÉèÊàë„É©„Éé„Éü„ÄÇ";
          this.imgBox.style.background = color || "#333";
          this.overlay.style.display = "flex";
        },
        close: function () {
          this.overlay.style.display = "none";
        },
      };

      // „Éá„Éº„Çø„Éô„Éº„Çπ: „É¶„Éã„ÉÉ„Éà & ÂõΩÂÆ∂ÊñπÈáù
      const DB = {
        UnitTypes: {
          inf: {
            name: "Ê≠©ÂÖµ",
            icon: "ü™ñ",
            type: "bat",
            sa: 12,
            ha: 2,
            def: 25,
            brk: 5,
            arm: 0,
            prc: 5,
            org: 60,
            spd: 4.0,
            cost: 300,
          },
          art: {
            name: "Á†≤ÂÖµ",
            icon: "üí•",
            type: "bat",
            sa: 45,
            ha: 5,
            def: 5,
            brk: 5,
            arm: 0,
            prc: 5,
            org: 10,
            spd: 3.5,
            cost: 700,
          },
          tank: {
            name: "Êà¶Ëªä",
            icon: "üöú",
            type: "bat",
            sa: 30,
            ha: 40,
            def: 15,
            brk: 55,
            arm: 50,
            prc: 45,
            org: 30,
            spd: 8.0,
            cost: 3000,
          },
          mot: {
            name: "Ëá™ÂãïËªä",
            icon: "üöö",
            type: "bat",
            sa: 15,
            ha: 3,
            def: 20,
            brk: 20,
            arm: 5,
            prc: 8,
            org: 55,
            spd: 12.0,
            cost: 1000,
          },
          mech: {
            name: "Ê©üÊ¢∞Âåñ",
            icon: "üöô",
            type: "bat",
            sa: 22,
            ha: 15,
            def: 35,
            brk: 30,
            arm: 25,
            prc: 20,
            org: 50,
            spd: 10.0,
            cost: 1800,
          },
          bike: {
            name: "Ëá™Ëª¢Ëªä",
            icon: "üö≤",
            type: "bat",
            sa: 14,
            ha: 2,
            def: 20,
            brk: 12,
            arm: 0,
            prc: 5,
            org: 55,
            spd: 9.0,
            cost: 400,
          },
          eng: {
            name: "Â∑•ÂÖµ",
            icon: "üõ†Ô∏è",
            type: "sup",
            sa: 5,
            ha: 2,
            def: 25,
            brk: 5,
            arm: 0,
            prc: 5,
            org: 20,
            spd: 0,
            cost: 500,
          },
          rec: {
            name: "ÂÅµÂØü",
            icon: "üî≠",
            type: "sup",
            sa: 4,
            ha: 1,
            def: 5,
            brk: 5,
            arm: 0,
            prc: 0,
            org: 10,
            spd: 1.1,
            cost: 400,
          },
          sup_art: {
            name: "ÊîØÊè¥Á†≤",
            icon: "üß®",
            type: "sup",
            sa: 25,
            ha: 2,
            def: 5,
            brk: 5,
            arm: 0,
            prc: 5,
            org: 0,
            spd: 0,
            cost: 600,
          },
        },
        AITemplates: {
          basic_inf: { bat: ["inf", "inf", "inf", "inf"], sup: ["eng"] },
          strong_inf: {
            bat: ["inf", "inf", "inf", "art"],
            sup: ["eng", "sup_art"],
          },
          bike_div: { bat: ["bike", "bike", "bike", "bike"], sup: ["rec"] },
          mot_div: {
            bat: ["mot", "mot", "mot", "tank"],
            sup: ["eng", "sup_art"],
          },
          mech_div: {
            bat: ["mech", "mech", "mech", "tank"],
            sup: ["eng", "rec"],
          },
          tank_div: {
            bat: ["tank", "tank", "mot", "mot"],
            sup: ["eng", "sup_art"],
          },
          elite_tank: {
            bat: ["tank", "tank", "tank", "mech", "mech"],
            sup: ["eng", "rec", "sup_art"],
          },
        },
        FocusTree: { GENERIC: [] },
        Terrain: {
          sea: { name: "Êµ∑", color: "#050a10", moveCost: 5, impassable: false },
          plains: {
            name: "Âπ≥Âéü",
            color: "#3e4e38",
            moveCost: 1,
            impassable: false,
          },
        },
      };

      // Focus Tree Generator
      const FT = [];
      const addF = (id, x, y, t, d, cost, req, eff, mut) =>
        FT.push({ id, x, y, t, d, cost, req, eff, mut });

      // ÊîøÊ≤ª (‰∏≠Â§Æ)
      addF(
        "pol_start",
        1400,
        50,
        "ÁúåÊîø„ÅÆÂà∑Êñ∞",
        "ÊîøÊ≤ªÂäõ+80",
        70,
        [],
        (c) => (c.pp += 80)
      );
      addF(
        "pol_council",
        1400,
        200,
        "ÁúåË≠∞‰ºö„ÅÆÊãõÈõÜ",
        "ÂÆâÂÆöÂ∫¶+5%",
        70,
        ["pol_start"],
        (c) => (c.st += 5)
      );

      // Ë¶áÈÅì„É´„Éº„Éà
      addF(
        "pol_auth",
        1250,
        350,
        "Ë¶áÈÅì„ÅÆËøΩÊ±Ç",
        "ÊîøÊ≤ªÂäõ+100, Êéí‰ªñ: ÁéãÈÅì",
        100,
        ["pol_council"],
        (c) => {
          c.pp += 100;
          c.ws += 10;
        },
        ["pol_demo"]
      );
      addF(
        "pol_auth_1",
        1250,
        500,
        "‰∏≠Â§ÆÈõÜÊ®©Âåñ",
        "ÊîøÊ≤ªÂäõ+150",
        120,
        ["pol_auth"],
        (c) => (c.pp += 150)
      );
      addF(
        "pol_auth_2",
        1250,
        650,
        "ËªçÂõΩ‰∏ªÁæ©",
        "‰∫∫ÁöÑ+5000",
        120,
        ["pol_auth_1"],
        (c) => (c.mp += 5000)
      );
      addF(
        "pol_auth_3",
        1250,
        800,
        "Èö£Áúå„Å∏„ÅÆÂ®ÅÂúß",
        "Â§ñ‰∫§ÂúßÂäõÂº∑Âåñ",
        140,
        ["pol_auth_2"],
        (c) => UI.notify("Â§ñ‰∫§ÁöÑÂúßÂäõ„ÇíÂº∑Âåñ„Åó„Åæ„Åó„Åü")
      );
      addF(
        "pol_auth_end",
        1250,
        1000,
        "Ë¶áÈÅì„ÅÆÂÆ£Ë®Ä",
        "SEÁô∫Áîü: Ë¶áÊ®©Á¢∫Á´ã",
        200,
        ["pol_auth_3"],
        (c) => {
          SuperEvent.trigger(
            "Ë¶áÊ®©„ÉéÁ¢∫Á´ã",
            "Âäõ„Ç≥„ÇΩ„Ç¨Ê≠£Áæ©„Éá„Ç¢„É´„ÄÇÂº±ËÄÖ„ÉãÁîüÂ≠ò„ÉéÊ®©Âà©„Éä„Ç∑„ÄÇ",
            "Á∑èÁµ±Âè∏‰ª§ÈÉ®",
            "üëë",
            "#500",
            "Êàë„Ç¨ÊÑè„Éé„Éû„Éû„Éã„ÄÇ"
          );
          c.ws = 100;
          c.pp += 500;
        }
      );

      // ÁéãÈÅì„É´„Éº„Éà
      addF(
        "pol_demo",
        1550,
        350,
        "ÁéãÈÅì„ÅÆÁµ±Ê≤ª",
        "ÂÆâÂÆö+10%, Êéí‰ªñ: Ë¶áÈÅì",
        100,
        ["pol_council"],
        (c) => {
          c.st += 10;
          c.pp += 50;
        },
        ["pol_auth"]
      );
      addF(
        "pol_demo_1",
        1550,
        500,
        "Âú∞ÊñπËá™Ê≤ª„ÅÆÂ∞äÈáç",
        "ÂÆâÂÆö+10%",
        120,
        ["pol_demo"],
        (c) => (c.st += 10)
      );
      addF(
        "pol_demo_2",
        1550,
        650,
        "Áî£Ê•≠ÈÄ£Êê∫ÂçîÂÆö",
        "Â∑•Â†¥+2",
        140,
        ["pol_demo_1"],
        (c) => {
          c.fac += 2;
          UI.notify("ÂçîÂäõ„Å´„Çà„ÇäÂ∑•Â†¥Âª∫Ë®≠");
        }
      );
      addF(
        "pol_demo_3",
        1550,
        800,
        "Âπ≥Âíå„ÅÆÁ•≠ÂÖ∏",
        "ÂÆâÂÆö+20%",
        140,
        ["pol_demo_2"],
        (c) => {
          c.st += 20;
          SuperEvent.trigger(
            "Âπ≥Âíå„ÉéÁ•≠ÂÖ∏",
            "Êà¶„Ç§„ÉèÁµÇ„ÉØ„ÉÉ„Çø„ÄÇ‰ªä„Ç≥„ÇΩÁπÅÊ†Ñ„ÉéÊôÇ„ÉÄ„ÄÇ",
            "Áü•‰∫ãÈÄ£Âêà",
            "üïäÔ∏è",
            "#284",
            "Ê∞∏ÈÅ†„ÉéÂπ≥Âíå„É≤„ÄÇ"
          );
        }
      );

      // Áî£Ê•≠ (Â∑¶)
      addF(
        "ind_start",
        900,
        200,
        "Áî£Ê•≠ÈñãÁô∫Ë®àÁîª",
        "Â∑•Â†¥+1",
        100,
        ["pol_start"],
        (c) => (c.fac += 1)
      );
      // ÈáçÂ∑•Ê•≠
      addF(
        "ind_heavy_1",
        800,
        350,
        "ÈáçÂ∑•Ê•≠Âåñ",
        "Â∑•Â†¥+1",
        100,
        ["ind_start"],
        (c) => (c.fac += 1)
      );
      addF(
        "ind_heavy_2",
        800,
        500,
        "„Ç≥„É≥„Éì„Éä„Éº„ÉàÂª∫Ë®≠",
        "Â∑•Â†¥+2",
        150,
        ["ind_heavy_1"],
        (c) => (c.fac += 2)
      );
      addF(
        "ind_heavy_3",
        800,
        650,
        "Ë≥áÊ∫êÊé°Êéò",
        "Ë£ÖÂÇô+3000",
        120,
        ["ind_heavy_2"],
        (c) => (c.eq += 3000)
      );
      addF(
        "ind_nuc",
        700,
        850,
        "ÂéüÂ≠êÂäõÁ†îÁ©∂",
        "Á†îÁ©∂ÂÆå‰∫Ü",
        300,
        ["ind_heavy_3"],
        (c) => UI.notify("ÂéüÂ≠êÂäõÁ†îÁ©∂ÊâÄ„ÅåÂÆåÊàê„Åó„Åæ„Åó„Åü...")
      );
      // „Éè„Ç§„ÉÜ„ÇØ
      addF(
        "ind_tech_1",
        1000,
        350,
        "ÈõªÂ≠êÁî£Ê•≠",
        "Âª∫Ë®≠ÈÄüÂ∫¶+10%",
        100,
        ["ind_start"],
        (c) =>
          (c.factoryBuildSpeedBonus = (c.factoryBuildSpeedBonus || 0) + 0.1)
      );
      addF(
        "ind_tech_2",
        1000,
        500,
        "„Ç∑„É™„Ç≥„É≥ÂàóÂ≥∂",
        "Â∑•Â†¥+1, Âª∫Ë®≠+10%",
        150,
        ["ind_tech_1"],
        (c) => {
          c.fac += 1;
          c.factoryBuildSpeedBonus += 0.1;
        }
      );
      addF(
        "ind_tech_3",
        1000,
        650,
        "Ëá™ÂãïÂåñÂ∑•Â†¥",
        "Â∑•Â†¥+3",
        200,
        ["ind_tech_2"],
        (c) => (c.fac += 3)
      );
      addF(
        "ind_cap",
        1000,
        850,
        "È¶ñÈÉΩÊîπÈÄ†Ë®àÁîª",
        "ÂÆâÂÆö+15%, Â∑•Â†¥+2",
        200,
        ["ind_tech_3"],
        (c) => {
          c.st += 15;
          c.fac += 2;
        }
      );

      // Ëªç‰∫ã (Âè≥)
      addF(
        "mil_start",
        1900,
        200,
        "Ëá™Ë°õÈöä„ÅÆÂÜçÁ∑®",
        "XP+20",
        80,
        ["pol_start"],
        (c) => (c.xp += 20)
      );
      // Ê©üÂãïÊà¶
      addF(
        "mil_mob_1",
        1800,
        350,
        "Ê©üÂãïÊà¶„Éâ„ÇØ„Éà„É™„É≥",
        "Á™ÅÁ†¥+10%",
        120,
        ["mil_start"],
        (c) => UI.notify("Ê©üÂãïÊà¶„Éâ„ÇØ„Éà„É™„É≥Êé°Áî®")
      );
      addF(
        "mil_mob_2",
        1800,
        500,
        "Êà¶ËªäÈÉ®ÈöäÂâµË®≠",
        "Ë£ÖÂÇô+500, XP+50",
        150,
        ["mil_mob_1"],
        (c) => {
          c.eq += 500;
          c.xp += 50;
        }
      );
      addF(
        "mil_mob_3",
        1800,
        650,
        "ÈõªÊíÉÊà¶",
        "ÂÖ®ËªçÈÄüÂ∫¶+10%(Ê¶ÇÂøµ)",
        150,
        ["mil_mob_2"],
        (c) => UI.notify("ÈõªÊíÉÊà¶ÁêÜË´ñ„ÅÆÁ†îÁ©∂ÂÆå‰∫Ü")
      );
      // ÊåÅ‰πÖÊà¶
      addF(
        "mil_def_1",
        2000,
        350,
        "ÊåÅ‰πÖÊà¶„Éâ„ÇØ„Éà„É™„É≥",
        "Èò≤Âæ°+10%",
        120,
        ["mil_start"],
        (c) => (c.territoryDefBonus = (c.territoryDefBonus || 0) + 0.1)
      );
      addF(
        "mil_def_2",
        2000,
        500,
        "Ë¶ÅÂ°ûÁ∑öÂª∫Ë®≠",
        "ÂÆâÂÆö+5%",
        150,
        ["mil_def_1"],
        (c) => (c.st += 5)
      );
      addF(
        "mil_def_3",
        2000,
        650,
        "ÂõΩÊ∞ëÁöÜÂÖµ",
        "‰∫∫ÁöÑ+20000",
        150,
        ["mil_def_2"],
        (c) => (c.mp += 20000)
      );
      // ÁâπÊÆä
      addF(
        "mil_spec",
        1900,
        800,
        "Ê±∫Êà¶ÂÖµÂô®„ÅÆÈñãÁô∫",
        "SEÁô∫Áîü",
        250,
        ["mil_mob_3", "mil_def_3"],
        (c) => {
          c.fac += 2;
          c.eq += 5000;
          SuperEvent.trigger(
            "Ê±∫Êà¶ÂÖµÂô®",
            "„ÇΩ„É¨„ÉèÂÖ®„ÉÜ„É≤ÁÑ°„ÉãÂ∏∞„Çπ„ÄÅÊÇ™È≠î„ÉéÂäõ„ÄÇ",
            "ÊäÄË°ìÊú¨ÈÉ®",
            "‚ò¢Ô∏è",
            "#000",
            "‰∏ñÁïå„ÉèÈúá„Ç®„É´„ÄÇ"
          );
        }
      );

      // Â§©‰∏ãÁµ±‰∏Ä
      addF(
        "fin_unify",
        1400,
        1200,
        "Â§©‰∏ãÂ∏ÉÊ≠¶",
        "ÂÖ®„Çπ„ÉÜ„Éº„Çø„ÇπÂ§ßÂπÖ‰∏äÊòá",
        365,
        ["pol_auth_end", "ind_cap", "mil_spec"],
        (c) => {
          c.pp += 1000;
          c.st = 100;
          c.ws = 100;
          c.mp += 50000;
          c.fac += 10;
          SuperEvent.trigger(
            "Â§©‰∏ãÁµ±‰∏Ä",
            "Êà¶‰π±„Éé‰∏ñ„ÉèÁµÇ„ÉØ„É™„ÄÅÊñ∞„Çø„ÉäÁß©Â∫è„Ç¨Áîü„Éû„É¨„É´„ÄÇ",
            "Â§ßÁ∑èÁµ±",
            "üóæ",
            "#b71c1c",
            "‰∏áÊ≠≥ÔºÅ‰∏áÊ≠≥ÔºÅ"
          );
        }
      );

      DB.FocusTree.GENERIC = FT;

      const CapitalCoords = {
        P1: { lat: 43.064, lon: 141.347 },
        P13: { lat: 35.689, lon: 139.692 },
        P47: { lat: 26.212, lon: 127.681 },
        P27: { lat: 34.693, lon: 135.502 },
        P23: { lat: 35.181, lon: 136.906 },
        P40: { lat: 33.606, lon: 130.418 },
      };
      const MapSys = { hexes: [] };

      const UI = {
        init: function () {
          this.update();
        },
        update: function () {
          const p = Game.countries[Game.player];
          if (!p) return;
          $("res-pp").innerText = ~~p.pp;
          $("res-st").innerText = p.st + "%";
          $("res-ws").innerText = p.ws + "%";
          $("res-man").innerText = nFmt(p.mp);
          $("res-fac").innerText = p.fac;
          $("res-eq").innerText = nFmt(p.eq);
          $("res-xp").innerText = ~~p.xp;
          $("val-wt").innerText = Game.tension + "%";
          $("player-flag").innerText = p.flag;
          $("army-count").innerText = Game.units.filter(
            (u) => u.tag === Game.player
          ).length;
          const ts = Game.calcStats(p.template);
          $("army-tmpl-stats").innerHTML = `<span>‚öîÔ∏è Ëªü:${ts.sa} Á°¨:${
            ts.ha
          }</span><span>üõ°Ô∏è Èò≤:${ts.def} Ë≤´:${
            ts.prc
          }</span><span>üöú Ë£Ö:${ts.arm.toFixed(0)}</span>`;
          $("recruit-cost").innerText = `‰∫∫ÁöÑ:1000 Ë£ÖÂÇô:${ts.cost.toFixed(0)}`;
          if (p.focus) {
            const pct = (p.focusProg / p.focus.cost) * 100;
            $("sb-focus-curr").innerText = p.focus.t + " (" + ~~pct + "%)";
            $("sb-focus-bar").style.width = pct + "%";
          } else if (p.buildingFactory) {
            const pct =
              (p.buildingFactory.progress / p.buildingFactory.cost) * 100;
            $("sb-focus-curr").innerText = `${
              p.buildingFactory.name
            }‰∏≠... (${~~pct}%)`;
            $("sb-focus-bar").style.width = pct + "%";
          } else {
            $("sb-focus-curr").innerText = "ÂõΩÂÆ∂ÊñπÈáù„ÇíÈÅ∏Êäû";
            $("sb-focus-bar").style.width = "0%";
          }
        },
        updateSidebar: function () {
          const t = Game.selected || Game.player;
          const c = Game.countries[t];
          if (!c) return;
          $("sb-name").innerText = c.name;
          $("sb-portrait").innerText = c.flag;
          $("sb-ideology").innerText = "Prefecture";
          const diploMsg = $("diplo-msg");
          const diploContent = $("diplo-content");
          if (Game.selected && Game.selected !== Game.player) {
            diploMsg.style.display = "none";
            diploContent.style.display = "block";
            $("dp-name").innerText = c.name;
            $("dp-faction").innerText = c.faction || "„Å™„Åó";
            $("dp-war-status").style.display = Game.isWar(Game.player, t)
              ? "block"
              : "none";
            $("btn-declare-war").disabled = Game.isAlly(Game.player, t);
          } else {
            diploMsg.style.display = "block";
            diploContent.style.display = "none";
          }
        },
        toggleSidebar: function () {
          const sidebar = $("sidebar");
          sidebar.style.display =
            sidebar.style.display === "none" ? "flex" : "none";
        },
        tab: function (id) {
          document
            .querySelectorAll(".tab")
            .forEach((e) => e.classList.remove("active"));
          document
            .querySelectorAll(".view")
            .forEach((e) => e.classList.remove("active"));
          event.target.classList.add("active");
          $(`v-${id}`).classList.add("active");
        },
        openFocusTree: function () {
          const p = Game.countries[Game.player];
          if (!p) return;
          const tree = DB.FocusTree.GENERIC;
          $("focus-nodes").innerHTML = "";
          $("focus-lines").innerHTML = "";
          tree.forEach((f) => {
            const el = $c("div", "focus-node");
            el.style.left = f.x + "px";
            el.style.top = f.y + "px";
            el.innerHTML = `<div class="focus-title">${f.t}</div><div class="focus-desc">${f.d}</div><div class="focus-cost">(${f.cost} days)</div>`;
            const comp = p.completedFocuses.includes(f.id);
            const excluded =
              f.mut && f.mut.some((m) => p.completedFocuses.includes(m));
            const avail =
              !comp &&
              !excluded &&
              f.req.every((r) => p.completedFocuses.includes(r));

            if (comp) el.classList.add("completed");
            else if (excluded) el.classList.add("exclusive-locked");
            else if (
              avail &&
              !((p.focus && p.focus.id !== f.id) || p.buildingFactory)
            ) {
              el.classList.add("available");
              el.onclick = () => Game.startFocus(f.id);
            } else el.classList.add("locked");
            if (p.focus && p.focus.id === f.id) el.classList.add("available");
            $("focus-nodes").appendChild(el);
            f.req.forEach((rid) => {
              const par = tree.find((x) => x.id === rid);
              if (par) {
                const l = document.createElementNS(
                  "http://www.w3.org/2000/svg",
                  "line"
                );
                l.setAttribute("x1", par.x + 120);
                l.setAttribute("y1", par.y + 110);
                l.setAttribute("x2", f.x + 120);
                l.setAttribute("y2", f.y);
                l.setAttribute("stroke", comp ? "var(--hl)" : "#555");
                l.setAttribute("stroke-width", "2");
                $("focus-lines").appendChild(l);
              }
            });
            // Êéí‰ªñÁ∑ö
            if (f.mut)
              f.mut.forEach((mid) => {
                const mNode = tree.find((x) => x.id === mid);
                if (mNode && mNode.x > f.x) {
                  const l2 = document.createElementNS(
                    "http://www.w3.org/2000/svg",
                    "line"
                  );
                  l2.setAttribute("x1", f.x + 200);
                  l2.setAttribute("y1", f.y + 40);
                  l2.setAttribute("x2", mNode.x + 40);
                  l2.setAttribute("y2", mNode.y + 40);
                  l2.setAttribute("stroke", "#d32f2f");
                  l2.setAttribute("stroke-width", "2");
                  l2.setAttribute("stroke-dasharray", "5,5");
                  $("focus-lines").appendChild(l2);
                }
              });
          });
          const modal = $("focus-modal");
          modal.style.display = "flex";
          // „Éâ„É©„ÉÉ„Ç∞„Çπ„ÇØ„É≠„Éº„É´
          const area = $("focus-scroll-area");
          area.scrollLeft = 1000;
          area.scrollTop = 0;
          let isDown = false,
            sX,
            sY,
            sL,
            sT;
          area.onmousedown = (e) => {
            isDown = true;
            sX = e.pageX;
            sY = e.pageY;
            sL = area.scrollLeft;
            sT = area.scrollTop;
            area.style.cursor = "grabbing";
          };
          area.onmouseleave = () => {
            isDown = false;
            area.style.cursor = "grab";
          };
          area.onmouseup = () => {
            isDown = false;
            area.style.cursor = "grab";
          };
          area.onmousemove = (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - sX;
            const y = e.pageY - sY;
            area.scrollLeft = sL - x;
            area.scrollTop = sT - y;
          };
        },
        openDesigner: function () {
          Designer.open();
        },
        closeDesigner: function () {
          $("design-modal").style.display = "none";
        },
        updateFocusModal: function () {
          if ($("focus-modal").style.display === "flex") this.openFocusTree();
        },
        closeFocusTree: function () {
          $("focus-modal").style.display = "none";
        },
        notify: function (m, t) {
          const d = $c("div", "news");
          d.innerHTML = `<div style="font-weight:bold;margin-bottom:3px;color:#aaa">Day ${Game.day}</div>${m}`;
          if (t === "war") {
            d.style.borderLeftColor = "var(--danger)";
            d.style.background = "rgba(60,10,10,.95)";
          } else if (t === "success") d.style.borderLeftColor = "var(--hl)";
          else if (t === "warn") {
            d.style.borderLeftColor = "var(--warn)";
            d.style.background = "rgba(60,60,10,.95)";
          }
          $("news-feed").prepend(d);
          setTimeout(() => d.remove(), 6000);
        },
        showStartScreen: function () {
          const list = $("country-list");
          list.innerHTML = "";
          const sortedTags = Object.keys(Game.countries)
            .filter((t) => t !== "_SEA")
            .sort((a, b) => Game.countries[b].fac - Game.countries[a].fac);
          sortedTags.forEach((tag) => {
            const c = Game.countries[tag];
            if (c.provs.length === 0) return;
            const d = $c("div", "country-card");
            d.innerHTML = `<div class="c-flag" style="color:${c.col}">${
              c.flag
            }</div><div class="c-name">${
              c.name
            }</div><div class="c-info">Â∑•Â†¥:${c.fac} ‰∫∫ÁöÑ:${nFmt(c.mp)}</div>`;
            d.onclick = () => Game.startGame(tag);
            list.appendChild(d);
          });
          $("start-screen").style.display = "flex";
          $("loading-overlay").style.display = "none";
        },
      };

      const Input = {
        isDown: false,
        isDrag: false,
        isShift: false,
        isRight: false,
        sx: 0,
        sy: 0,
        lastX: 0,
        lastY: 0,
        selUnits: [],
        battlePoints: [],
        battleLineEl: null,
        mapWrapEl: null,
        init: function () {
          this.mapWrapEl = $("map-wrap");
          window.addEventListener("keydown", (e) => {
            if (e.key === "Shift") this.isShift = true;
          });
          window.addEventListener("keyup", (e) => {
            if (e.key === "Shift") this.isShift = false;
          });
          this.mapWrapEl.addEventListener("mousedown", (e) => {
            this.isDown = true;
            this.isDrag = false;
            this.sx = e.clientX;
            this.sy = e.clientY;
            this.lastX = e.clientX;
            this.lastY = e.clientY;
            this.isRight = e.button === 2;
            if (e.button === 1) e.preventDefault();
            if (this.isRight && this.selUnits.length > 0) {
              this.battlePoints = [];
              this.startBattleLine(e);
            }
            this.mapWrapEl.style.cursor = "grabbing";
          });
          window.addEventListener("mousemove", (e) => {
            if (!this.isDown) return;
            const dx = e.clientX - this.lastX,
              dy = e.clientY - this.lastY;
            if (
              Math.abs(e.clientX - this.sx) > 5 ||
              Math.abs(e.clientY - this.sy) > 5
            )
              this.isDrag = true;
            if (this.isShift && !this.isRight) {
              this.updateBoxSelect(e);
            } else if (this.isRight && this.selUnits.length > 0) {
              this.updateBattleLine(e);
            } else if (!this.isRight && this.isDrag) {
              Renderer.x += dx;
              Renderer.y += dy;
              Renderer.update();
            }
            this.lastX = e.clientX;
            this.lastY = e.clientY;
          });
          window.addEventListener("mouseup", (e) => {
            this.isDown = false;
            this.mapWrapEl.style.cursor = "grab";
            $("select-box").style.display = "none";
            if (this.isDrag) {
              if (this.isShift && !this.isRight) this.finishBoxSelect();
              else if (this.isRight && this.selUnits.length > 0)
                this.executeBattlePlan();
              return;
            }
            const target = e.target;
            if (target.classList.contains("hex")) {
              const h = MapSys.hexes[target.dataset.id];
              if (h) this.onHexClick(e, h);
            } else if (target.closest(".unit-grp")) {
              const uEl = target.closest(".unit-grp");
              const u = Game.units.find((x) => x.el === uEl);
              if (u) {
                e.stopPropagation();
                this.onHexClick(e, u.hex);
              }
            }
          });
          this.mapWrapEl.addEventListener(
            "wheel",
            (e) => {
              e.preventDefault();
              const f = e.deltaY > 0 ? 0.9 : 1.1;
              Renderer.s = Math.max(0.4, Math.min(5, Renderer.s * f));
              Renderer.update();
            },
            { passive: false }
          );
        },
        updateBoxSelect: function (e) {
          const box = $("select-box");
          const x = Math.min(this.sx, e.clientX),
            y = Math.min(this.sy, e.clientY);
          const w = Math.abs(e.clientX - this.sx),
            h = Math.abs(e.clientY - this.sy);
          box.style.left = x + "px";
          box.style.top = y + "px";
          box.style.width = w + "px";
          box.style.height = h + "px";
          box.style.display = "block";
        },
        finishBoxSelect: function () {
          const b = $("select-box").getBoundingClientRect();
          const mapWrapRect = this.mapWrapEl.getBoundingClientRect();
          this.selUnits = Game.units.filter((u) => {
            if (u.tag !== Game.player) return false;
            const sx = u.x * Renderer.s + Renderer.x + mapWrapRect.left;
            const sy = u.y * Renderer.s + Renderer.y + mapWrapRect.top;
            return (
              sx >= b.left && sx <= b.right && sy >= b.top && sy <= b.bottom
            );
          });
          this.hlUnits();
        },
        startBattleLine: function (e) {
          const pt = this.screenToWorld(e.clientX, e.clientY);
          this.battlePoints.push(pt);
          if (this.battleLineEl) this.battleLineEl.remove();
          this.battleLineEl = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "polyline"
          );
          this.battleLineEl.setAttribute("class", "battle-line");
          Renderer.uiLayer.appendChild(this.battleLineEl);
        },
        updateBattleLine: function (e) {
          const pt = this.screenToWorld(e.clientX, e.clientY);
          const last = this.battlePoints[this.battlePoints.length - 1];
          if (Math.hypot(pt.x - last.x, pt.y - last.y) > 10) {
            this.battlePoints.push(pt);
            const ptsStr = this.battlePoints
              .map((p) => `${p.x},${p.y}`)
              .join(" ");
            this.battleLineEl.setAttribute("points", ptsStr);
          }
        },
        executeBattlePlan: function () {
          if (!this.battleLineEl) return;
          this.battleLineEl.remove();
          this.battleLineEl = null;
          if (this.battlePoints.length < 2) return;
          const targetHexes = [];
          this.battlePoints.forEach((pt) => {
            let closest = null,
              minD = Infinity;
            MapSys.hexes.forEach((h) => {
              if (Math.abs(h.x - pt.x) > 50 || Math.abs(h.y - pt.y) > 50)
                return;
              const d = (h.x - pt.x) ** 2 + (h.y - pt.y) ** 2;
              if (d < 900) {
                if (d < minD) {
                  minD = d;
                  closest = h;
                }
              }
            });
            if (closest && !targetHexes.includes(closest))
              targetHexes.push(closest);
          });
          if (targetHexes.length === 0) return;
          const sortedUnits = [...this.selUnits].sort((a, b) => a.y - b.y);
          sortedUnits.forEach((u, i) => {
            const targetIndex = ~~(
              (i / sortedUnits.length) *
              targetHexes.length
            );
            const target = targetHexes[targetIndex];
            const path = this.findPath(u.hex, target, u.tag);
            if (path) {
              u.path = path;
              u.state = "moving";
            }
          });
          UI.notify(`${this.selUnits.length} Â∏´Âõ£„Åå‰ΩúÊà¶Ë°åÂãï„ÇíÈñãÂßã`);
        },
        screenToWorld: function (sx, sy) {
          const rect = this.mapWrapEl.getBoundingClientRect();
          return {
            x: (sx - rect.left - Renderer.x) / Renderer.s,
            y: (sy - rect.top - Renderer.y) / Renderer.s,
          };
        },
        onHexClick: function (e, hex) {
          if (e.button === 0) {
            if (hex.owner && hex.owner !== "_SEA") {
              Game.selected = hex.owner;
              UI.updateSidebar();
            } else {
              Game.selected = null;
              UI.updateSidebar();
            }
            const myUnitsInHex = Game.units.filter(
              (u) => u.tag === Game.player && u.hex === hex
            );
            if (myUnitsInHex.length > 0) {
              if (this.isShift) {
                myUnitsInHex.forEach((u) => {
                  const idx = this.selUnits.indexOf(u);
                  if (idx >= 0) this.selUnits.splice(idx, 1);
                  else this.selUnits.push(u);
                });
              } else {
                this.selUnits = myUnitsInHex;
              }
            } else {
              if (!this.isShift) this.selUnits = [];
            }
            this.hlUnits();
          } else if (e.button === 2 && this.selUnits.length) {
            const uTag = this.selUnits[0].tag;
            const path = this.findPath(this.selUnits[0].hex, hex, uTag);
            if (path) {
              this.selUnits.forEach((u) => {
                u.path = [...path];
                u.state = "moving";
              });
              const m = document.createElement("div");
              m.style.cssText = `position:absolute;left:${e.clientX}px;top:${e.clientY}px;width:10px;height:10px;background:#0f0;border-radius:50%;pointer-events:none;z-index:99;animation:fade 1s;`;
              document.body.appendChild(m);
              setTimeout(() => m.remove(), 1000);
            } else {
              UI.notify("ÁßªÂãï„Åß„Åç„Åæ„Åõ„Çì", "warn");
            }
          }
        },
        hlUnits: function () {
          document
            .querySelectorAll(".unit-grp")
            .forEach((el) => el.classList.remove("selected"));
          this.selUnits.forEach((u) => u.el.classList.add("selected"));
          $("sel-count").innerText = this.selUnits.length;
        },
        findPath: function (start, end, unitTag) {
          const q = [{ h: start, cost: 0 }];
          const came = new Map();
          came.set(start, null);
          const costs = new Map();
          costs.set(start, 0);
          let limit = 0;
          const MAX_SEARCH = 300;
          const getMinCostNode = () => {
            let minCost = Infinity;
            let minIndex = -1;
            for (let i = 0; i < q.length; i++) {
              if (q[i].cost < minCost) {
                minCost = q[i].cost;
                minIndex = i;
              }
            }
            if (minIndex !== -1) return q.splice(minIndex, 1)[0];
            return null;
          };
          while (q.length && limit++ < MAX_SEARCH) {
            const curEntry = getMinCostNode();
            if (!curEntry) break;
            const cur = curEntry.h;
            if (cur === end) break;
            for (let n of cur.adj) {
              if (!n) continue;
              if (
                n.owner !== unitTag &&
                n.owner !== "_SEA" &&
                !Game.isWar(unitTag, n.owner) &&
                !Game.isAlly(unitTag, n.owner)
              )
                continue;
              let moveCost = 1;
              if (n.type === "sea") moveCost = 8;
              const newCost = costs.get(cur) + moveCost;
              if (!costs.has(n) || newCost < costs.get(n)) {
                costs.set(n, newCost);
                came.set(n, cur);
                q.push({ h: n, cost: newCost });
              }
            }
          }
          if (!came.has(end)) return null;
          const p = [];
          let t = end;
          while (t !== start) {
            p.push(t);
            t = came.get(t);
            if (!t) return null;
          }
          return p.reverse();
        },
      };

      const Renderer = {
        x: 0,
        y: 0,
        s: 1,
        layer: null,
        uiLayer: null,
        gameSvg: null,
        update: function () {
          $(
            "game-svg"
          ).style.transform = `translate(${this.x}px, ${this.y}px) scale(${this.s})`;
        },
        addUnit: function (u) {
          const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
          g.className.baseVal = "unit-grp";
          const inner = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "g"
          );
          inner.classList.add("unit-inner");
          inner.innerHTML = `<rect class="unit-box" x="-11" y="-7"/><rect class="unit-bar" x="-10" y="5" width="20" height="2"/><rect class="unit-org-bar" x="-10" y="3" width="20" height="2"/><text class="unit-icon" y="3">${u.icon}</text>`;
          g.appendChild(inner);
          g.setAttribute("transform", `translate(${u.x},${u.y})`);
          this.layer.appendChild(g);
          u.el = g;
          u.innerEl = inner;
          u.bar = inner.querySelector(".unit-bar");
          u.orgBar = inner.querySelector(".unit-org-bar");
        },
        updateUnit: function (u) {
          if (
            Math.abs(u.x - u.lastRx) > 0.1 ||
            Math.abs(u.y - u.lastRy) > 0.1
          ) {
            u.el.setAttribute("transform", `translate(${u.x},${u.y})`);
            u.lastRx = u.x;
            u.lastRy = u.y;
          }
          const hpW = (u.hp / 100) * 20;
          const orgW = (u.org / u.maxOrg) * 20;
          if (Math.abs(u.lastHpW - hpW) > 1) {
            u.bar.setAttribute("width", Math.max(0, hpW));
            u.lastHpW = hpW;
          }
          if (Math.abs(u.lastOrgW - orgW) > 1) {
            u.orgBar.setAttribute("width", Math.max(0, orgW));
            u.lastOrgW = orgW;
          }
        },
      };

      const AI = {
        runCountry: function (tag) {
          const c = Game.countries[tag];
          if (!c || c.provs.length === 0 || c.dead) return;
          if (
            !c.focus &&
            !c.buildingFactory &&
            c.pp >= 70 &&
            Math.random() < 0.05
          ) {
            c.pp -= 50;
            c.buildingFactory = { cost: 10, progress: 0, name: "Â∑•Â†¥Âª∫Ë®≠" };
          }
          const enemies = Game.wars
            .filter((w) => w.atk === tag || w.def === tag)
            .map((w) => (w.atk === tag ? w.def : w.atk));
          const myUnits = Game.units.filter((u) => u.tag === tag);
          const armyLimit = Math.min(~~(c.fac * 2 + 5), 80);
          if (
            c.mp > 2000 &&
            myUnits.length < armyLimit &&
            (enemies.length > 0 || Math.random() < 0.05)
          ) {
            let targetTmpl = DB.AITemplates.basic_inf;
            const roll = Math.random();
            if (c.fac >= 15) {
              if (roll < 0.3) targetTmpl = DB.AITemplates.tank_div;
              else if (roll < 0.5) targetTmpl = DB.AITemplates.mech_div;
              else if (roll < 0.7) targetTmpl = DB.AITemplates.mot_div;
              else targetTmpl = DB.AITemplates.strong_inf;
            } else if (c.fac >= 8) {
              if (roll < 0.15) targetTmpl = DB.AITemplates.tank_div;
              else if (roll < 0.4) targetTmpl = DB.AITemplates.bike_div;
              else targetTmpl = DB.AITemplates.strong_inf;
            } else {
              if (roll < 0.3) targetTmpl = DB.AITemplates.bike_div;
              else targetTmpl = DB.AITemplates.basic_inf;
            }
            const stats = Game.calcStats(targetTmpl);
            if (c.eq >= stats.cost) {
              c.mp -= 1000;
              c.eq -= stats.cost;
              Game.spawnUnit(tag, c.capital, targetTmpl);
            }
          }
          if (!c.focus && !c.buildingFactory) {
            const tree = DB.FocusTree.GENERIC;
            const available = tree.filter(
              (f) =>
                !c.completedFocuses.includes(f.id) &&
                f.req.every((r) => c.completedFocuses.includes(r))
            );
            const valid = available.filter(
              (f) =>
                !f.mut || !f.mut.some((m) => c.completedFocuses.includes(m))
            );
            if (valid.length > 0 && c.pp >= valid[0].cost)
              Game.countries[tag].focus = valid[0];
          }
          const plannedMoves = new Set();
          myUnits.forEach((u) => {
            if (u.state === "moving" && u.path.length > 0)
              plannedMoves.add(u.path[u.path.length - 1].id);
          });
          const idleUnits = myUnits
            .filter((u) => u.state === "idle" && u.org > 20)
            .sort(() => Math.random() - 0.5);
          const frontline = Game.getFrontlineHexes(tag);
          let actions = 0;
          const APM = 15;
          for (let u of idleUnits) {
            if (actions >= APM) break;
            let bestTarget = null;
            let maxScore = -9999;
            u.hex.adj.forEach((n) => {
              if (n.owner === "_SEA" || n.owner === tag) return;
              if (!Game.isWar(tag, n.owner)) return;
              let score = 0;
              if (plannedMoves.has(n.id)) score -= 200;
              const enemyUnit = Game.getEnemyInHex(n, tag);
              if (!enemyUnit) score += 100;
              else {
                if (enemyUnit.org < 30) score += 50;
                else if (u.org < 40) score -= 50;
                else score += 10;
              }
              if (score > maxScore) {
                maxScore = score;
                bestTarget = n;
              }
            });
            if (bestTarget && maxScore > 0) {
              u.path = [bestTarget];
              u.state = "moving";
              actions++;
              plannedMoves.add(bestTarget.id);
              continue;
            }
            if (frontline.length > 0 && Math.random() < 0.3) {
              const f = frontline[Math.floor(Math.random() * frontline.length)];
              const d = (u.x - f.x) ** 2 + (u.y - f.y) ** 2;
              if (d < 10000) {
                const path = Input.findPath(u.hex, f, tag);
                if (path && path.length) {
                  u.path = path.slice(0, 5);
                  u.state = "moving";
                  actions++;
                  plannedMoves.add(path[path.length - 1].id);
                }
              }
            }
          }
          if (enemies.length === 0) {
            const neighbors = Game.getNeighbors(tag);
            if (neighbors.length > 0) {
              if (
                c.peaceTimer > 300 &&
                Math.random() < 0.3 &&
                myUnits.length > 4
              ) {
                const target =
                  neighbors[Math.floor(Math.random() * neighbors.length)];
                Game.declareWar(tag, target);
              }
            }
          }
        },
      };

      const Game = {
        day: 1,
        speed: 1,
        running: false,
        player: "",
        countries: {},
        units: [],
        wars: [],
        tension: 0,
        aiTimer: 0,
        lastTickTime: 0,
        tickInterval: 100,
        geoData: null,
        isMapOverridden: false,
        unitGrid: new Map(),

        init: async function () {
          if (!this.isMapOverridden) {
            await this.loadMapData();
          }
          Input.init();
          this.initCountries();
          this.initMap();
          UI.showStartScreen();
        },
        startGame: function (playerTag) {
          this.player = playerTag;
          this.countries[this.player].col = "#b71c1c";
          MapSys.hexes.forEach((h) => {
            if (h.owner === this.player) h.el.setAttribute("fill", "#b71c1c");
          });
          $("start-screen").style.display = "none";
          this.spawnInitialUnits();
          UI.init();
          this.setSpeed(1);
          this.lastTickTime = performance.now();
          requestAnimationFrame(this.loop.bind(this));
        },
        loadMapData: async function () {
          try {
            const res = await fetch(
              "https://raw.githubusercontent.com/dataofjapan/land/master/japan.geojson"
            );
            if (!res.ok) throw new Error("Network response was not ok");
            this.geoData = await res.json();
          } catch (e) {
            alert("„Éû„ÉÉ„Éó„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + e.message);
          }
        },
        loop: function (currentTime) {
          if (!this.running) {
            this.lastTickTime = currentTime;
            requestAnimationFrame(this.loop.bind(this));
            return;
          }
          const deltaTime = currentTime - this.lastTickTime;
          if (deltaTime >= this.tickInterval) {
            const ticksToProcess = Math.floor(deltaTime / this.tickInterval);
            for (let i = 0; i < ticksToProcess; i++) {
              this.processTick();
              this.lastTickTime += this.tickInterval;
            }
          }
          requestAnimationFrame(this.loop.bind(this));
        },
        processTick: function () {
          this.day++;
          const tags = Object.keys(this.countries);
          tags.forEach((tag) => {
            if (tag === "_SEA") return;
            const c = this.countries[tag];
            if (c.provs.length === 0 && !c.dead) return;
            c.pp += (0.5 + c.fac / 50) * (1 + (c.ppGainBonus || 0));
            c.eq +=
              c.fac *
              15 *
              (1 + (c.facProdBonus || 0)) *
              (1 + (c.eqProdBonus || 0));
            if (c.eq > 200000) c.eq = 200000;
            c.peaceTimer = (c.peaceTimer || 0) + 1;
            const fighting = this.units.some(
              (u) => u.tag === tag && u.innerEl.classList.contains("fighting")
            );
            c.xp += (0.05 + (fighting ? 0.3 : 0)) * (1 + (c.xpGainBonus || 0));
            if (c.xp > 500) c.xp = 500;
            if (c.focus) {
              c.focusProg++;
              if (c.focusProg >= c.focus.cost) this.completeFocus(c);
            } else if (c.buildingFactory) {
              c.buildingFactory.progress += 1 + (c.factoryBuildSpeedBonus || 0);
              if (c.buildingFactory.progress >= c.buildingFactory.cost) {
                c.fac++;
                c.pp -= 20;
                if (tag === this.player)
                  UI.notify(`${c.name} „ÅßÂ∑•Â†¥„ÅåÂÆåÊàê`, "success");
                c.buildingFactory = null;
              }
            }
            if (this.day % 30 === 0 && c.mp < 1e6) c.mp += c.fac * 100;
          });
          this.aiTimer++;
          if (this.aiTimer > 1) {
            const aiBatch = 8;
            const startIdx = (this.day * aiBatch) % tags.length;
            for (let i = 0; i < aiBatch; i++) {
              const t = tags[(startIdx + i) % tags.length];
              if (t !== this.player && t !== "_SEA") AI.runCountry(t);
            }
            this.aiTimer = 0;
          }
          this.updateUnits();
          UI.update();
        },
        initCountries: function () {
          this.countries = {};
          if (this.geoData && this.geoData.features) {
            this.geoData.features.forEach((f) => {
              const props = f.properties;
              const name = props.nam_ja || props.nam || "Unknown";
              const id = props.id
                ? "P" + props.id
                : name.replace(/[^a-zA-Z0-9]/g, "");
              this.countries[id] = {
                tag: id,
                name: name,
                col: nextColor(),
                flag: "üáØüáµ",
                mp: 50000 + Math.random() * 50000,
                fac: 2 + Math.floor(Math.random() * 3),
                eq: 5000,
                xp: 10,
                doctrine: "balanced",
                provs: [],
                pp: 50,
                st: 80,
                ws: 10,
                focus: null,
                focusProg: 0,
                completedFocuses: [],
                faction: null,
                template: DB.AITemplates.basic_inf,
                buildingFactory: null,
                treeType: "GENERIC",
                peaceTimer: 0,
              };
              if (name.includes("Tokyo") || name.includes("Êù±‰∫¨")) {
                this.countries[id].fac = 15;
                this.countries[id].mp = 300000;
              } else if (name.includes("Osaka") || name.includes("Â§ßÈò™")) {
                this.countries[id].fac = 12;
              } else if (name.includes("Aichi") || name.includes("ÊÑõÁü•")) {
                this.countries[id].fac = 10;
              } else if (name.includes("Fukuoka") || name.includes("Á¶èÂ≤°")) {
                this.countries[id].fac = 8;
              }
            });
          }
        },
        calcStats: function (tmpl) {
          let s = {
            sa: 0,
            ha: 0,
            def: 0,
            brk: 0,
            arm: 0,
            prc: 0,
            org: 0,
            spd: 999,
            cost: 0,
          };
          if (!tmpl || !tmpl.bat.length) return s;
          let batCount = 0;
          tmpl.bat.forEach((t) => {
            const d = DB.UnitTypes[t];
            if (!d) return;
            s.sa += d.sa;
            s.ha += d.ha;
            s.def += d.def;
            s.brk += d.brk;
            s.cost += d.cost;
            s.org += d.org;
            if (d.arm > s.arm) s.arm = d.arm * 0.3 + s.arm * 0.7;
            if (d.prc > s.prc) s.prc = d.prc * 0.4 + s.prc * 0.6;
            if (d.spd < s.spd) s.spd = d.spd;
            batCount++;
          });
          if (batCount > 0) s.org /= batCount;
          else s.spd = 0;
          tmpl.sup.forEach((t) => {
            const d = DB.UnitTypes[t];
            if (!d) return;
            s.sa += d.sa;
            s.ha += d.ha;
            s.def += d.def;
            s.brk += d.brk;
            s.cost += d.cost;
          });
          let maxArm = 0;
          tmpl.bat.forEach((t) => {
            if (DB.UnitTypes[t].arm > maxArm) maxArm = DB.UnitTypes[t].arm;
          });
          s.arm = (s.arm + maxArm) / 2;
          return s;
        },
        spawnInitialUnits: function () {
          Object.values(this.countries).forEach((c) => {
            if (c.tag === "_SEA") return;
            const n = Math.min(6, Math.max(1, ~~(c.fac / 3)));
            for (let i = 0; i < n; i++)
              if (c.provs.length) this.spawnUnit(c.tag, c.capital, c.template);
          });
        },
        spawnUnit: function (tag, hex, template) {
          if (!hex) return;
          const tmplCopy = { bat: [...template.bat], sup: [...template.sup] };
          const stats = this.calcStats(tmplCopy);
          const u = {
            id: Math.random().toString(36),
            tag: tag,
            x: hex.x,
            y: hex.y,
            hex: hex,
            state: "idle",
            path: [],
            hp: 100,
            org: stats.org,
            maxOrg: stats.org,
            template: tmplCopy,
            stats: stats,
            icon: DB.UnitTypes[tmplCopy.bat[0]].icon,
            lastRx: 0,
            lastRy: 0,
            lastHpW: 0,
            lastOrgW: 0,
          };
          this.units.push(u);
          this.addToGrid(u, hex);
          Renderer.addUnit(u);
        },
        addToGrid: function (u, hex) {
          if (!this.unitGrid.has(hex.id)) this.unitGrid.set(hex.id, []);
          this.unitGrid.get(hex.id).push(u);
        },
        removeFromGrid: function (u, hex) {
          if (!this.unitGrid.has(hex.id)) return;
          const arr = this.unitGrid.get(hex.id);
          const idx = arr.indexOf(u);
          if (idx !== -1) arr.splice(idx, 1);
          if (arr.length === 0) this.unitGrid.delete(hex.id);
        },
        getEnemyInHex: function (hex, myTag) {
          if (!this.unitGrid.has(hex.id)) return null;
          const enemies = this.unitGrid
            .get(hex.id)
            .filter((u) => u.tag !== myTag && this.isWar(u.tag, myTag));
          return enemies.length > 0 ? enemies[0] : null;
        },
        updateUnits: function () {
          for (let i = this.units.length - 1; i >= 0; i--) {
            const u = this.units[i];
            if (u.hp <= 0) {
              this.removeFromGrid(u, u.hex);
              u.el.remove();
              this.units.splice(i, 1);
            }
          }
          this.units.forEach((u) => {
            if (u.state === "idle" && u.org < u.maxOrg) u.org += 0.8;
            if (u.state === "moving" && u.path.length) {
              const next = u.path[0];
              if (!next) {
                u.path = [];
                u.state = "idle";
                return;
              }
              const enemyInNext = this.getEnemyInHex(next, u.tag);
              const enemyHere = this.getEnemyInHex(u.hex, u.tag);
              const enemy =
                enemyHere ||
                (Math.hypot(next.x - u.x, next.y - u.y) < 15
                  ? enemyInNext
                  : null);
              if (enemy) {
                u.innerEl.classList.add("fighting");
                if (Math.random() < 0.15) {
                  const enemyHardness = enemy.stats.arm > 5 ? 0.6 : 0.1;
                  const myHardness = u.stats.arm > 5 ? 0.6 : 0.1;
                  let myAtk =
                    u.stats.sa * (1 - enemyHardness) +
                    u.stats.ha * enemyHardness;
                  let enemyAtk =
                    enemy.stats.sa * (1 - myHardness) +
                    enemy.stats.ha * myHardness;
                  const myDmg = Math.max(
                    1,
                    (myAtk - enemy.stats.def / 4) * (0.8 + Math.random() * 0.4)
                  );
                  const enemyDmg = Math.max(
                    1,
                    (enemyAtk - u.stats.brk / 4) * (0.8 + Math.random() * 0.4)
                  );
                  enemy.org -= myDmg * 0.8;
                  enemy.hp -= myDmg * 0.2;
                  u.org -= enemyDmg * 0.8;
                  u.hp -= enemyDmg * 0.2;
                  if (u.org <= 0) {
                    u.org = 0;
                    u.state = "idle";
                    u.path = [];
                    u.innerEl.classList.remove("fighting");
                  }
                }
                return;
              } else {
                u.innerEl.classList.remove("fighting");
              }
              const unitSpeed = u.stats.spd * (u.org / u.maxOrg);
              const terrainMoveCost = DB.Terrain[next.type].moveCost || 1;
              const spd = unitSpeed / terrainMoveCost;
              if (u.hex.type === "sea") u.el.classList.add("moving-sea");
              else u.el.classList.remove("moving-sea");
              const dx = next.x - u.x,
                dy = next.y - u.y;
              const dist = Math.hypot(dx, dy);
              if (
                dist < 10 &&
                next.owner !== "_SEA" &&
                next.owner !== u.tag &&
                this.isWar(u.tag, next.owner) &&
                !this.isAlly(u.tag, next.owner)
              ) {
                if (u.org > 5) this.conquerHex(u, next);
              }
              if (dist <= spd || isNaN(dist)) {
                this.removeFromGrid(u, u.hex);
                u.x = next.x;
                u.y = next.y;
                u.hex = next;
                u.path.shift();
                this.addToGrid(u, next);
                if (
                  u.hex.owner !== "_SEA" &&
                  u.hex.owner !== u.tag &&
                  this.isWar(u.tag, u.hex.owner) &&
                  !this.isAlly(u.tag, u.hex.owner)
                ) {
                  if (u.org > 5) this.conquerHex(u, u.hex);
                }
                if (u.path.length === 0) u.state = "idle";
              } else {
                u.x += (dx / dist) * spd;
                u.y += (dy / dist) * spd;
              }
              Renderer.updateUnit(u);
            }
          });
        },
        recruit: function () {
          const c = this.countries[this.player];
          const stats = this.calcStats(c.template);
          const armySize = this.units.filter(
            (u) => u.tag === this.player
          ).length;
          const maxArmy = Math.min(~~(c.fac * 1.5 + 2), 50);
          if (armySize >= maxArmy) {
            UI.notify(`Â∏´Âõ£‰∏äÈôê„Åß„Åô (ÁèæÂú®:${armySize}/${maxArmy})`, "warn");
            return;
          }
          const actualEqCost = stats.cost;
          if (c.mp >= 1000 && c.eq >= actualEqCost) {
            c.mp -= 1000;
            c.eq -= actualEqCost;
            if (c.provs.length) {
              this.spawnUnit(this.player, c.capital, c.template);
              UI.notify("Â∏´Âõ£Á∑®ÊàêÂÆå‰∫Ü");
            }
          } else {
            UI.notify(
              `Ë≥áÊ∫ê‰∏çË∂≥ (ÂøÖË¶Å: ‰∫∫ÁöÑ1000, Ë£ÖÂÇô${actualEqCost.toFixed(0)})`,
              "warn"
            );
          }
        },
        buildFactory: function () {
          const c = this.countries[this.player];
          if (c.focus) {
            UI.notify("ÂõΩÂÆ∂ÊñπÈáùÂÆüË°å‰∏≠„ÅØÂ∑•Â†¥„ÇíÂª∫Ë®≠„Åß„Åç„Åæ„Åõ„Çì„ÄÇ", "warn");
            return;
          }
          if (c.buildingFactory) {
            UI.notify("Êó¢„Å´Â∑•Â†¥„ÇíÂª∫Ë®≠‰∏≠„Åß„Åô„ÄÇ", "warn");
            return;
          }
          if (c.pp < 50) {
            UI.notify("ÊîøÊ≤ªÂäõ„ÅåË∂≥„Çä„Åæ„Åõ„Çì (50ÂøÖË¶Å)„ÄÇ", "warn");
            return;
          }
          c.pp -= 50;
          c.buildingFactory = { cost: 10, progress: 0, name: "Â∑•Â†¥Âª∫Ë®≠" };
          UI.notify("Â∑•Â†¥Âª∫Ë®≠„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü", "success");
          UI.update();
        },
        calcCapitals: function () {
          Object.values(this.countries).forEach((c) => {
            if (c.tag === "_SEA") return;
            if (c.provs.length === 0) {
              if (c.capIcon) {
                c.capIcon.remove();
                c.capIcon = null;
              }
              c.capital = null;
              return;
            }
            if (c.capital && c.provs.includes(c.capital)) {
              if (!c.capIcon) {
                const t = document.createElementNS(
                  "http://www.w3.org/2000/svg",
                  "text"
                );
                t.textContent = "‚òÖ";
                t.setAttribute("fill", "gold");
                t.setAttribute(
                  "style",
                  "pointer-events:none;font-size:18px;font-weight:bold;text-shadow:0 0 2px #000"
                );
                $("game-svg").appendChild(t);
                c.capIcon = t;
              }
              c.capIcon.setAttribute("x", c.capital.x - 9);
              c.capIcon.setAttribute("y", c.capital.y + 6);
              return;
            }
            let best = c.provs[0];
            const fixed =
              CapitalCoords[c.tag] ||
              (c.name.includes("Tokyo") ? CapitalCoords["P13"] : null);
            if (fixed) {
              let minD = Infinity;
              c.provs.forEach((p) => {
                const d = (p.lat - fixed.lat) ** 2 + (p.lon - fixed.lon) ** 2;
                if (d < minD) {
                  minD = d;
                  best = p;
                }
              });
            } else {
              let cx = 0,
                cy = 0;
              c.provs.forEach((p) => {
                cx += p.gx;
                cy += p.gy;
              });
              cx /= c.provs.length;
              cy /= c.provs.length;
              let minD = Infinity;
              c.provs.forEach((p) => {
                const d = (p.gx - cx) ** 2 + (p.gy - cy) ** 2;
                if (d < minD) {
                  minD = d;
                  best = p;
                }
              });
            }
            c.capital = best;
            if (!c.capIcon) {
              const t = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "text"
              );
              t.textContent = "‚òÖ";
              t.setAttribute("fill", "gold");
              t.setAttribute(
                "style",
                "pointer-events:none;font-size:18px;font-weight:bold;text-shadow:0 0 2px #000"
              );
              $("game-svg").appendChild(t);
              c.capIcon = t;
            }
            c.capIcon.setAttribute("x", best.x - 9);
            c.capIcon.setAttribute("y", best.y + 6);
          });
        },
        conquerHex: function (u, h) {
          const oldOwner = h.owner;
          if (oldOwner === u.tag) return;
          const oc = this.countries[oldOwner];
          const nc = this.countries[u.tag];
          if (h.factories > 0) {
            nc.fac += h.factories;
            if (oc) oc.fac -= h.factories;
          }
          if (oc) oc.provs = oc.provs.filter((x) => x !== h);
          h.owner = u.tag;
          h.el.setAttribute("fill", nc.col);
          nc.provs.push(h);
          if (oc && oc.capital === h) {
            UI.notify(`${nc.name} „Åå ${oc.name} „ÅÆÈ¶ñÈÉΩ„ÇíÈô•ËêΩ„Åï„Åõ„ÅüÔºÅ`, "war");
            oc.ws -= 50;
            if (oc.ws < 20) {
              this.capitulate(oldOwner, u.tag);
            } else {
              this.calcCapitals();
            }
          } else {
            this.calcCapitals();
          }
        },
        capitulate: function (loser, winner) {
          const lc = this.countries[loser];
          const wc = this.countries[winner];
          SuperEvent.trigger(
            "ÂõΩÂÆ∂„ÉéÂ¥©Â£ä",
            `${lc.name} „ÉèÊïóÂåó„Ç∑„Çø„ÄÇÊ≠¥Âè≤„ÉèÂãùËÄÖ„Éã„É®„ÉÉ„ÉÜ‰Ωú„É©„É¨„É´„ÄÇ`,
            `${wc.name} Âè∏‰ª§ÈÉ®`,
            "üíÄ",
            lc.col
          );
          [...lc.provs].forEach((p) => {
            p.owner = winner;
            p.el.setAttribute("fill", wc.col);
            wc.provs.push(p);
            wc.fac += p.factories;
          });
          lc.fac = 0;
          lc.provs = [];
          lc.dead = true;
          this.units = this.units.filter((u) => u.tag !== loser);
          document.querySelectorAll(".unit-grp").forEach((el) => {
            const uObj = this.units.find((x) => x.el === el);
            if (!uObj) el.remove();
          });
          this.unitGrid.forEach((v, k) => {
            this.unitGrid.set(
              k,
              v.filter((u) => u.tag !== loser)
            );
          });
          this.wars = this.wars.filter(
            (w) => w.atk !== loser && w.def !== loser
          );
          this.calcCapitals();
        },
        declareWar: function (a, b) {
          if (this.isWar(a, b) || this.isAlly(a, b)) return;
          this.wars.push({ atk: a, def: b });
          this.tension += 2;
          if (this.countries[a]) this.countries[a].peaceTimer = 0;
          if (this.countries[b]) this.countries[b].peaceTimer = 0;
          UI.notify(
            `${this.countries[a].name} „Åå ${this.countries[b].name} „Å´ÂÆ£Êà¶Â∏ÉÂëäÔºÅ`,
            "war"
          );
          if (a === this.player || b === this.player) {
            const enemy = a === this.player ? b : a;
            const cName = this.countries[enemy].name;
            SuperEvent.trigger(
              "ÈñãÊà¶„ÉéÁãºÁÖô",
              "Âπ≥Âíå„ÉéÊôÇ‰ª£„ÉèÁµÇ„ÉØ„ÉÉ„Çø„ÄÇÊàë„ÄÖ„ÉèÊà¶„Ç¶„Ç∑„Ç´„Éä„Ç§„ÄÇ",
              `${cName} ÊîøÂ∫ú`,
              "‚öîÔ∏è",
              this.countries[enemy].col
            );
          }
          if (Game.selected === b) UI.updateSidebar();
        },
        isWar: function (a, b) {
          return this.wars.some(
            (w) => (w.atk === a && w.def === b) || (w.atk === b && w.def === a)
          );
        },
        isAlly: function (tag1, tag2) {
          if (!this.countries[tag1] || !this.countries[tag2]) return false;
          const f1 = this.countries[tag1].faction;
          const f2 = this.countries[tag2].faction;
          return f1 && f2 && f1 === f2;
        },
        justifyWar: function () {
          if (this.selected && this.selected !== this.player) {
            UI.notify("Ê≠£ÂΩìÂåñÂ∑•‰ΩúÈñãÂßã...");
            setTimeout(() => this.declareWar(this.player, this.selected), 2000);
          }
        },
        startFocus: function (fid) {
          const c = this.countries[this.player];
          if (c.buildingFactory) {
            UI.notify("Â∑•Â†¥Âª∫Ë®≠‰∏≠„ÅØÂõΩÂÆ∂ÊñπÈáù„ÇíÈñãÂßã„Åß„Åç„Åæ„Åõ„Çì„ÄÇ", "warn");
            return;
          }
          const tree = DB.FocusTree.GENERIC;
          const f = tree.find((x) => x.id === fid);
          if (f && c.pp >= f.cost) {
            c.focus = f;
            c.focusProg = 0;
            UI.updateFocusModal();
          }
        },
        completeFocus: function (c) {
          c.focus.eff(c);
          c.completedFocuses.push(c.focus.id);
          if (c.tag === this.player) {
            UI.notify(`${c.focus.t} ÂÆå‰∫Ü`, "success");
            UI.closeFocusTree();
          }
          c.focus = null;
        },
        setSpeed: function (s) {
          this.speed = s;
          this.running = s > 0;
          this.tickInterval = s === 0 ? Infinity : 1000 / (s * 10);
          document
            .querySelectorAll(".spd-btn")
            .forEach((b, i) =>
              b.classList.toggle("active", [0, 1, 3, 5].indexOf(s) === i)
            );
        },
        getNeighbors: function (tag) {
          const c = this.countries[tag];
          if (!c) return [];
          const neighbors = new Set();
          c.provs.forEach((p) => {
            p.adj.forEach((a) => {
              if (a.owner !== "_SEA" && a.owner !== tag) neighbors.add(a.owner);
            });
          });
          return Array.from(neighbors);
        },
        getFrontlineHexes: function (tag) {
          const c = this.countries[tag];
          if (!c) return [];
          return c.provs.filter((p) =>
            p.adj.some(
              (a) =>
                a.owner !== "_SEA" &&
                a.owner !== tag &&
                this.isWar(tag, a.owner)
            )
          );
        },
        initMap: function () {
          const svg = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "svg"
          );
          svg.id = "game-svg";
          svg.setAttribute("width", "100%");
          svg.setAttribute("height", "100%");
          svg.setAttribute("overflow", "visible");
          svg.style.transformOrigin = "0 0";
          svg.style.willChange = "transform";
          const defs = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "defs"
          );
          defs.innerHTML =
            '<filter id="glow"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>';
          svg.appendChild(defs);
          Input.mapWrapEl.appendChild(svg);

          let minX = Infinity,
            minY = Infinity,
            maxX = -Infinity,
            maxY = -Infinity;
          this.geoData.features.forEach((f) => {
            f.geometry.coordinates.forEach((poly) => {
              const rings = f.geometry.type === "MultiPolygon" ? poly : [poly];
              rings.forEach((ring) => {
                const arr = f.geometry.type === "MultiPolygon" ? ring : rings;
                const points = Array.isArray(arr[0][0]) ? arr.flat() : arr;
                points.forEach((p) => {
                  const x = p[0];
                  const y = p[1];
                  if (x < minX) minX = x;
                  if (x > maxX) maxX = x;
                  if (y < minY) minY = y;
                  if (y > maxY) maxY = y;
                });
              });
            });
          });
          minX -= 1;
          maxX += 1;
          minY -= 1;
          maxY += 1;
          const mapScale = 120;
          const R = 18;
          const mapPixelWidth = (maxX - minX) * mapScale * 1.5;
          const mapPixelHeight = (maxY - minY) * mapScale * 1.8;
          const cols = Math.ceil(mapPixelWidth / (R * 1.5));
          const rows = Math.ceil(mapPixelHeight / (R * 1.732));

          MapSys.hexes = [];
          const isInside = (point, vs) => {
            let x = point[0],
              y = point[1];
            let inside = false;
            for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
              let xi = vs[i][0],
                yi = vs[i][1];
              let xj = vs[j][0],
                yj = vs[j][1];
              let intersect =
                yi > y != yj > y && x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
              if (intersect) inside = !inside;
            }
            return inside;
          };

          for (let gy = 0; gy < rows; gy++) {
            for (let gx = 0; gx < cols; gx++) {
              const x = gx * R * 1.5 + 25;
              const y = gy * R * 1.732 + 25 + (gx % 2 ? R * 0.866 : 0);
              const lon = x / (mapScale * 1.5) + minX;
              const lat = maxY - y / (mapScale * 1.8);
              let owner = "_SEA";
              for (const f of this.geoData.features) {
                let inside = false;
                const props = f.properties;
                const polyType = f.geometry.type;
                const coords = f.geometry.coordinates;
                if (polyType === "Polygon") {
                  coords.forEach((ring) => {
                    if (isInside([lon, lat], ring)) inside = true;
                  });
                } else if (polyType === "MultiPolygon") {
                  coords.forEach((poly) => {
                    poly.forEach((ring) => {
                      if (isInside([lon, lat], ring)) inside = true;
                    });
                  });
                }
                if (inside) {
                  const name = props.nam_ja || props.nam;
                  const id = props.id
                    ? "P" + props.id
                    : name.replace(/[^a-zA-Z0-9]/g, "");
                  owner = id;
                  break;
                }
              }
              const hexEl = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "polygon"
              );
              const points = [];
              for (let i = 0; i < 6; i++) {
                const angle = (Math.PI / 3) * i;
                points.push(
                  `${x + R * Math.cos(angle)},${y + R * Math.sin(angle)}`
                );
              }
              hexEl.setAttribute("points", points.join(" "));
              hexEl.setAttribute("class", owner === "_SEA" ? "hex sea" : "hex");
              hexEl.dataset.id = MapSys.hexes.length;

              if (owner !== "_SEA") {
                const c = this.countries[owner];
                if (c) {
                  hexEl.setAttribute("fill", c.col);
                  this.countries[owner].provs.push({
                    id: MapSys.hexes.length,
                    gx,
                    gy,
                    x,
                    y,
                    lon,
                    lat,
                    el: hexEl,
                    adj: [],
                    owner: owner,
                    type: "plains",
                    factories: 0,
                  });
                  const h =
                    this.countries[owner].provs[
                      this.countries[owner].provs.length - 1
                    ];
                  MapSys.hexes.push(h);
                  svg.appendChild(hexEl);
                  if (Math.random() < 0.05) {
                    h.factories = 1;
                    c.fac++;
                  }
                }
              } else {
                svg.appendChild(hexEl);
                MapSys.hexes.push({
                  id: MapSys.hexes.length,
                  gx,
                  gy,
                  x,
                  y,
                  lon,
                  lat,
                  el: hexEl,
                  adj: [],
                  owner: "_SEA",
                  type: "sea",
                  factories: 0,
                });
              }
            }
          }
          const gridMap = {};
          MapSys.hexes.forEach((h) => (gridMap[`${h.gx},${h.gy}`] = h));
          MapSys.hexes.forEach((a) => {
            const isOdd = a.gx % 2 === 1;
            const offsets = isOdd
              ? [
                  [0, -1],
                  [0, 1],
                  [-1, 0],
                  [-1, 1],
                  [1, 0],
                  [1, 1],
                ]
              : [
                  [0, -1],
                  [0, 1],
                  [-1, -1],
                  [-1, 0],
                  [1, -1],
                  [1, 0],
                ];
            offsets.forEach((o) => {
              const k = `${a.gx + o[0]},${a.gy + o[1]}`;
              if (gridMap[k]) a.adj.push(gridMap[k]);
            });
          });
          Renderer.layer = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "g"
          );
          svg.appendChild(Renderer.layer);
          Renderer.uiLayer = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "g"
          );
          svg.appendChild(Renderer.uiLayer);
          this.calcCapitals();
          Renderer.s = 0.6;
          const screenCX = Input.mapWrapEl.offsetWidth / 2;
          const screenCY = Input.mapWrapEl.offsetHeight / 2;
          Renderer.x = screenCX - 800 * Renderer.s;
          Renderer.y = screenCY - 600 * Renderer.s;
          Renderer.update();
        },
      };

      const Designer = {
        current: { bat: [], sup: [] },
        open: function () {
          const p = Game.countries[Game.player];
          if (!p) return;
          this.current = { bat: [...p.template.bat], sup: [...p.template.sup] };
          $("ds-xp").innerText = ~~p.xp;
          $("design-modal").style.display = "flex";
          this.renderOptions();
          this.updateGrid();
        },
        renderOptions: function () {
          const batDiv = $("opt-battalions");
          const supDiv = $("opt-support");
          batDiv.innerHTML = "";
          supDiv.innerHTML = "";
          Object.keys(DB.UnitTypes).forEach((key) => {
            const u = DB.UnitTypes[key];
            const el = $c("div", "unit-opt");
            el.innerHTML = `<span class="unit-opt-icon">${u.icon}</span><span>${u.name}</span><span style="font-size:10px;color:#aaa;margin-left:auto">Cost:${u.cost}</span>`;
            el.onclick = () => this.addUnit(key, u.type);
            if (u.type === "bat") batDiv.appendChild(el);
            else supDiv.appendChild(el);
          });
        },
        addUnit: function (id, type) {
          if (type === "bat") {
            if (this.current.bat.length < 9) {
              this.current.bat.push(id);
              this.updateGrid();
            } else UI.notify("‰∏ªÂäõÂ§ßÈöä„ÅØ„Åì„Çå‰ª•‰∏äËøΩÂä†„Åß„Åç„Åæ„Åõ„Çì", "warn");
          } else {
            if (this.current.sup.length < 3 && !this.current.sup.includes(id)) {
              this.current.sup.push(id);
              this.updateGrid();
            } else
              UI.notify("ÊîØÊè¥‰∏≠Èöä„ÅØËøΩÂä†„Åß„Åç„Å™„ÅÑ„Åã„ÄÅÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô", "warn");
          }
        },
        removeUnit: function (idx, type) {
          if (type === "bat") this.current.bat.splice(idx, 1);
          else this.current.sup.splice(idx, 1);
          this.updateGrid();
        },
        updateGrid: function () {
          const gb = $("grid-bat");
          const gs = $("grid-sup");
          gb.innerHTML = "";
          gs.innerHTML = "";
          this.current.bat.forEach((uid, i) => {
            const u = DB.UnitTypes[uid];
            const el = $c("div", "slot filled");
            el.innerHTML = `${u.icon}<div class="rm" onclick="event.stopPropagation();Designer.removeUnit(${i},'bat')">√ó</div>`;
            gb.appendChild(el);
          });
          for (let i = this.current.bat.length; i < 6; i++) {
            gb.appendChild($c("div", "slot"));
          }
          this.current.sup.forEach((uid, i) => {
            const u = DB.UnitTypes[uid];
            const el = $c("div", "slot filled");
            el.innerHTML = `${u.icon}<div class="rm" onclick="event.stopPropagation();Designer.removeUnit(${i},'sup')">√ó</div>`;
            gs.appendChild(el);
          });
          for (let i = this.current.sup.length; i < 3; i++) {
            gs.appendChild($c("div", "slot"));
          }
          this.calcPreview();
        },
        calcPreview: function () {
          const s = Game.calcStats(this.current);
          $("ds-atk-s").innerText = s.sa.toFixed(1);
          $("ds-atk-h").innerText = s.ha.toFixed(1);
          $("ds-def").innerText = s.def.toFixed(1);
          $("ds-brk").innerText = s.brk.toFixed(1);
          $("ds-arm").innerText = s.arm.toFixed(1);
          $("ds-cost").innerText = s.cost.toFixed(0);
        },
        save: function () {
          const p = Game.countries[Game.player];
          const cost = 10;
          if (p.xp < cost) {
            UI.notify(`Èô∏ËªçÁµåÈ®ìÂÄ§„ÅåË∂≥„Çä„Åæ„Åõ„Çì (ÂøÖË¶Å: ${cost})`, "warn");
            return;
          }
          if (this.current.bat.length === 0) {
            UI.notify("Â∞ë„Å™„Åè„Å®„ÇÇ1„Å§„ÅÆ‰∏ªÂäõÂ§ßÈöä„ÅåÂøÖË¶Å„Åß„Åô", "warn");
            return;
          }
          p.xp -= cost;
          p.template = {
            bat: [...this.current.bat],
            sup: [...this.current.sup],
          };
          UI.notify("Â∏´Âõ£Á∑®Êàê„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü", "success");
          UI.closeDesigner();
          UI.update();
        },
      };

      document.addEventListener("DOMContentLoaded", () => Game.init());
    </script>
  </body>
</html>
